---
title: "NMDS"
author: "Kate Culhane"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = '..')
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width=7, fig.height=5)
```

<br>

```{r packages and data}

# Load packages

library(tidyverse)
library(vegan)
library(goeveg)
library(pairwiseAdonis)
library(ggvegan)

# Update functions

select <- dplyr::select

# Load data

matrix_df <- read_csv('output_data/species_matrix.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

matrix_adj_df <- read_csv('output_data/species_matrix_adj.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

site_meta <- read_csv('raw_data/field_data/site_metadata.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

habitat_metrics <- read_csv('output_data/habitat_metrics.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

```

```{r data wrangling}

# Transform data frames into matrices

matrix <- as.matrix(matrix_df[-c(1,2)])
rownames(matrix) <- matrix_df$site

matrix_adj <- as.matrix(matrix_adj_df[-c(1,2)])
rownames(matrix_adj) <- matrix_adj_df$site

# Create species matrix using relative abundance

matrix_rel <- decostand(matrix, method = "total")

# Severity data frame

sevs <- select(matrix_df, site, severity)

```

### Community structure

```{r nmds, include=FALSE}

# Choose a distance metric

rankindex(habitat_metrics$severity,
          wisconsin(matrix_rel),
          indicies = c('bray', 'euclidean', 'manhattan', 'horn'),
          method = 'spearman')

# Bray-curtis performs well to separate communities along the fire severity gradient
# Although Euclidean and Kul also are good?!

# NMDS with relative abundance data (2 dimensions)

ord <- metaMDS(matrix_rel,
               distance = 'bray',
               k = 2)
ord$stress # stress = 0.117
stressplot(ord)

# NMDS with relative abundance data (3 dimensions)

ord2 <- metaMDS(matrix_rel,
               distance = 'bray',
               k = 3)
ord2$stress # stress = 0.066
stressplot(ord2)

# Scree plot to check stress per number of dimensions
dimcheckMDS(matrix_rel, distance = "bray", k = 10, trymax = 20)
# Stress is significantly reduced after 2 dimensions

```

**NMDS plot showing community structure across the three fire severities:** 

```{r nmds plot, echo=FALSE}

cols <- c('darkgreen', 'orange', 'red')

par(mar = c(4,4,1,1))

plot(ord, display = 'sites', type = 'n')

points(ord, display = 'sites',
       cex = 1.5, pch = 19, col = cols[sevs$severity])

ordiellipse(ord, groups = sevs$severity,
            label = TRUE, col = cols, lwd = 2)

text(ord, display = 'species',
     cex = 0.6)

title(main = 'NMDS in 2 dimensions')

```

```{r ANOSIM and adonis, eval=FALSE}

# Attach severity data to species matrix

matrix_rel
attach(sevs)

# Compare community similarity across fire severities using ANOSIM

smamm_ano <- anosim(matrix_rel, severity)
summary(smamm_ano)
plot(smamm_ano)

# Compare community dispersion across fire severities using betadisper

smamm_dist <- vegdist(matrix_rel)

smamm_bd <- betadisper(smamm_dist, severity)

smamm_bd
plot(smamm_bd)
boxplot(smamm_bd)

permutest(smamm_bd)
anova(smamm_bd)

# p > 0.05 for both --> no difference in dispersion across fire severities
# Satisfies the assumption for adonis



# Compare community similarity across fire severities using adonis
# Adonis is more robust because it is less sensitive to dispersion

smamm_ado <- adonis(matrix_rel ~ severity,
                    permuatations = 999,
                    method = 'bray')
smamm_ado

# p = 0.001 --> communities are significantly different between fire severity treatments



# Pairwise Adonis

smamm_ado_pw <- pairwise.adonis(matrix_rel, severity)

smamm_ado_pw

# Adjusted p-value (Bonferroni correction)
# unb vs mod: 0.018
# unb vs high: 0.003
# mod vs high: 0.336

```

- NMDS in two dimensions using relative abundance species matrix and Wisconsin correction on Bray-Curtis distances
- Appears to be fewer sites because some of them exactly overlap
- Adonis F=4.739, p=0.002
- Pairwise Adonis unb vs. mod p=0.018, unb vs high p=0.003 (Bonferroni correction)
- Considered using ANOSIM instead of Adonis, but Adonis is more robust because it is less sensitive to dispersion (also used betadisper to determine that dispersion was similar across treatments in order to satisfy assumptions of Adonis)
- Species codes:
    - SPBE = California ground squirrel
    - GLSA = northern flying squirrel
    - TAAM = yellow-pine chipmunk
    - TAQU = long-eared chipmunk
    - TASE = shadow chipmunk
    - NEFU = dusky-footed woodrat
    - PEMA = North American deer mouse
    - PEBO = brush mouse
    - PETR = Pinyon mouse
    - REME = western harvest mouse
    - SOTR = Trowbridge's shrew

<br>

### Habitat drivers

**Individual habitat drivers of small mammal communities:**

```{r env nmds}

# Fit individual environmental variables

fit <- envfit(ord, habitat_metrics[,3:16], permutations = 1000)

# NMDS plot with arrows for environmental variables

par(mar = c(4,4,1,1))
plot(ord, display = 'sites', type = 'n')
points(ord, display = 'sites',
       cex = 1.5, pch = 19, col = cols[sevs$severity])
ordiellipse(ord, groups = sevs$severity, # shows se around centroids
            label = FALSE, col = cols, lwd = 2)
plot(fit,
     col = 'black', lwd = 3)

```

- Habitat variables:
    - *avg_severity* - mean severity of pixels within the site, based on MTBS fire severity data (0-3 = unburned-high severity)
    - *dist_to_edge* - distance from the site center to the burn boundary (negative for sites outside the burn boundary)
    - *tree_bm* - density of adult tree biomass (live or dead) (kg/m^2^)
    - *shrub_bm* - density of live shrub biomass (kg/m^2^)
    - *grass_bm* - density of live grass biomass (kg/m^2^)
    - *forb_bm* - density of live forb biomass (kg/m^2^)
    - *tree_density* - density of trees (live or dead) (indv/m^2^)
    - *tree_survival* - proportion of live trees (%)
    - *veg_cover* - total proportion of vegetation cover (all species/life-forms - can sum to >100) (both transects) (%)
    - *litter_cover* - proportion of litter cover (%)
    - *cwd_volume* - density of coarse woody debris volume (m^3^/m^2^)
    - *tree_H* - Shannon diversity of adult trees
    - *shrub_H* - Shannon diversity of adult trees
    - *forb_H* - Shannon diversity of adult trees

<br>

**NMDS plot with PCA scores:**

```{r env nmds 2}

# Fit environmental variables

fit2 <- envfit(ord, habitat_metrics[,17:19], permutations = 1000)

# NMDS plot with arrows for environmental variables

par(mar = c(4,4,1,1))
plot(ord, xlim = c(-1.8,1.8), display = 'sites', type = 'n')
points(ord, display = 'sites',
       cex = 1.5, pch = 19, col = cols[sevs$severity])
ordiellipse(ord, groups = sevs$severity, # by default plots ellipse with std error around centroids
            label = FALSE, col = cols, lwd = 2)
plot(fit2,
     col = 'black', lwd = 3)
text(ord, display = 'species',
     cex = 0.7, col = 'grey30')

```

- *fire_score* = avg_severity + dist_to_edge + tree_survival
- *biomass_score* = tree_bm + shrub_bm + grass_bm + forb_bm
- *diversity_score* = tree_H + shrub_H + forb_H

<br>

**NMDS plot with best variables from mvGLM:**

```{r model nmds}

# Data frame with only the variables from the model

model_vars <- habitat_metrics %>% 
  select(site, severity, tree_bm, shrub_bm, forb_bm, veg_cover, litter_cover, cwd_volume)

# Fit environmental variables

fit3 <- envfit(ord, model_vars[,3:8], permutations = 1000)

# NMDS plot with arrows for environmental variables

par(mar = c(4,4,1,1))
plot(ord, xlim = c(-1.8,1.2), diplay = 'sites', type = 'n')
points(ord, display = 'sites',
       cex = 1, pch = 19, col = cols[sevs$severity])
ordiellipse(ord, groups = sevs$severity, # by default plots ellipse with std error around centroids
            label = FALSE, col = cols, lwd = 2)
plot(fit3,
     col = 'black', lwd = 3, cex = 0.8)
text(ord, display = 'species',
     cex = 0.7, col = 'grey30')

```

<br> 

**Clean NMDS plots with ggplot:**

```{r, include=FALSE}

# Ordination plot with ggplot

# Data frames with point and vector information

site_points <- fortify(ord) %>% 
  filter(Score == 'sites') %>% 
  full_join(sevs, by = c('Label' = 'site')) %>% 
  dplyr::rename(group = severity)


spp_points <- fortify(ord) %>% 
  filter(Score == 'species')

vectors <- fortify(fit3) %>% 
  mutate(xend = NMDS1*2,
         yend = NMDS2*2,
         xlab = case_when(
           Label == 'tree_bm' ~ xend,
           Label == 'shrub_bm' ~ xend,
           Label == 'forb_bm' ~ xend,
           Label == 'veg_cover' ~ xend,
           Label == 'litter_cover' ~ xend,
           Label == 'cwd_volume' ~ xend
         ),
         ylab = case_when(
           Label == 'tree_bm' ~ yend,
           Label == 'shrub_bm' ~ yend,
           Label == 'forb_bm' ~ yend,
           Label == 'veg_cover' ~ yend,
           Label == 'litter_cover' ~ yend,
           Label == 'cwd_volume' ~ yend
         ),
         lab = case_when(
           Label == 'tree_bm' ~ 'Tree biomass',
           Label == 'shrub_bm' ~ 'Shrub biomass',
           Label == 'forb_bm' ~ 'Forb biomass',
           Label == 'veg_cover' ~ 'Understory cover',
           Label == 'litter_cover' ~ 'Litter cover',
           Label == 'cwd_volume' ~ 'CWD volume'
         ))

# Data frame with ellipse information

plot.new()
ord_el <- ordiellipse(ord, groups = sevs$severity)

veganCovEllipse<-function (cov, center = c(0, 0), scale = 1, npoints = 100) 
  {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
  }

df_ell <- data.frame()

for(g in levels(site_points$group)){
  df_ell <- rbind(df_ell, cbind(as.data.frame(with(site_points[site_points$group==g,],
                  veganCovEllipse(ord_el[[g]]$cov,ord_el[[g]]$center,ord_el[[g]]$scale)))
                                ,group=g))
}

```

```{r}

ggplot() +
  geom_path(data = df_ell,
            aes(x = NMDS1, y = NMDS2, color = group),
            size = 1) +
  geom_point(data = site_points,
             aes(x = NMDS1, y = NMDS2, color = group),
             size = 2) +
  # geom_text(data = spp_points,
  #           aes(x = NMDS1, y = NMDS2, label = Label2),
  #           size = 3, color = 'grey40') +
  geom_segment(data = vectors[c(4,5,6),],
               aes(x = 0, y = 0, xend = xend, yend = yend),
               arrow = arrow(length = unit(0.02, 'npc'), type = 'closed'),
               size = 0.7) +
  # geom_segment(data = vectors[5,],
  #              aes(x = 0, y = 0, xend = xend, yend = yend),
  #              arrow = arrow(length = unit(0.03, 'npc'), type = 'closed'),
  #              size = 0.9) +
  geom_text(data = vectors[c(4,5,6),],
            aes(x = xlab, y = ylab, label = lab),
            size = 4) +
  # geom_text(data = vectors[5,],
  #           aes(x = xlab, y = ylab, label = lab),
  #           size = 4, fontface = 'bold') +
  geom_label(data=site_points, aes(x=0.75,y=0.6,label='NMDS in 2 dim\nstress = 0.12')) +
  scale_color_manual(values = c('darkgreen', 'orange', 'red')) +
  scale_x_continuous(limits = c(-0.7,1)) +
  scale_y_continuous(limits = c(-0.5,0.7)) +
  theme_classic() +
  theme(panel.border = element_rect(fill = NA),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        legend.position = 'none') +
  coord_fixed()

ggsave('figs/fig5b.png', plot = last_plot(),
       width = 5, height = 3, units = 'in')

```

```{r eval=FALSE}
rmarkdown::render('code/08_nmds.Rmd', output_file = '../docs/08_nmds.html')
```
