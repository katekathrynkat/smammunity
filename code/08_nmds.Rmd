---
title: "NMDS"
author: "Kate Culhane"
date: "December 23, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = '..')
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width=7, fig.height=5)
```

<br>

```{r packages and data}

# Load necessary packages

library(tidyverse)
library(vegan)
library(goeveg)
library(pairwiseAdonis)
library(ggvegan)

# Update functions

select <- dplyr::select

# Load necessary data

matrix_df <- read_csv('output_data/species_matrix.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

matrix_adj_df <- read_csv('output_data/species_matrix_adj.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

site_meta <- read_csv('raw_data/field_data/site_metadata.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

habitat_metrics <- read_csv('output_data/habitat_metrics.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

```


```{r data wrangling}

# Transform data frames into matrices

matrix <- as.matrix(matrix_df[-c(1,2)])
rownames(matrix) <- matrix_df$site

matrix_adj <- as.matrix(matrix_adj_df[-c(1,2)])
rownames(matrix_adj) <- matrix_adj_df$site

# Severity data frame

sevs <- select(matrix_df, site, severity)

```

### Community composition

```{r distance metric, eval=FALSE}

# Choose a distance metric

rankindex(habitat_metrics$severity,
          wisconsin(matrix_adj),
          indicies = c('bray', 'euclidean', 'manhattan', 'horn'),
          method = 'spearman')

# Bray-curtis performs well to separate communities along the fire severity gradient
# Although Euclidean and Kul also are good?!

```

```{r nmds, include=FALSE}

# NMDS with raw abundance data (2 dimensions)

ord <- metaMDS(matrix,
               distance = 'bray',
               k = 2)
ord$stress # stress = 0.18
stressplot(ord)

# NMDS with abundance data adjusted for trapping effort (2 dimensions)

set.seed(1)
ord_adj_2dim <- metaMDS(matrix_adj,
                        distance = 'bray',
                        k = 2)
ord_adj_2dim$stress # stress = 0.18
stressplot(ord_adj_2dim)



set.seed(2)
ord_adj_2dim_2 <- metaMDS(matrix_adj,
                          distance = 'bray',
                          k = 2)
ord_adj_2dim_2$stress # stress = 0.18
stressplot(ord_adj_2dim_2)


procrustes <- procrustes(ord_adj_2dim, ord_adj_2dim_2) # compares ordination solutions
summary(procrustes)
plot(procrustes)

# NMDS returns two solutions (local minima) which appear fairly different



# NMDS with abundance data adjusted for trapping effort (3 dimensions)

set.seed(5)
ord_adj_3dim <- metaMDS(matrix_adj,
                        distance = 'bray',
                        k = 3)

ord_adj_3dim$stress # stress = 0.09
stressplot(ord_adj_3dim)

# Only one solution with 3 dimensions and stress is sifnificantly lower, so this is probably the best model to use



# Scree plot to check stress per number of dimensions

dimcheckMDS(matrix_adj, distance = "bray", k = 10, trymax = 20)
# Stress is significantly reduced after 3 dimensions

```

**NMDS plot showing community composition across the three fire severities:** 

```{r nmds plot, echo=FALSE}

# 3 dimensions

colors <- c('darkgreen', 'orange', 'red')

par(mar = c(4,4,1,1))

plot(ord_adj_3dim, display = 'sites',
     type = 'n')

points(ord_adj_3dim, display = 'sites',
       cex = 1.5, pch = 19, col = colors[matrix_adj_df$severity])

ordiellipse(ord, groups = matrix_df$severity,
            label = TRUE, col = colors, lwd = 2)

text(ord_adj_3dim, display = 'species',
     cex = 0.6)

title(main = 'NMDS in 3 dimensions')

```

```{r ANOSIM and adonis, eval=FALSE}

# Attach severity data to species matrix

matrix_adj_sev <- matrix_adj
attach(sevs)

# Compare community similarity across fire severities using ANOSIM

smamm_ano <- anosim(matrix_adj_sev, severity)
summary(smamm_ano)
plot(smamm_ano)

# Compare community dispersion across fire severities using betadisper

smamm_dist <- vegdist(matrix_adj_sev)

smamm_bd <- betadisper(smamm_dist, severity)

smamm_bd
plot(smamm_bd)
boxplot(smamm_bd)

permutest(smamm_bd)
anova(smamm_bd)

# p > 0.05 for both --> no difference in dispersion across fire severities
# Satisfies the assumption for adonis



# Compare community similarity across fire severities using adonis
# Adonis is more robust because it is less sensitive to dispersion

smamm_ado <- adonis(matrix_adj_sev ~ severity,
                    permuatations = 999,
                    method = 'bray')

smamm_ado

# p = 0.001 --> communities are significantly different between fire severity treatments



# Pairwise Adonis

smamm_ado_ph <- pairwise.adonis(matrix_adj_sev, severity)

smamm_ado_ph

# Adjusted p-value (Bonferroni correction)
# unb vs mod: 0.216
# unb vs high: 0.003
# mod vs high: 0.051 (but this is sometime significant based on permutation)

```

        pairs Df SumsOfSqs  F.Model        R2 p.value p.adjusted sig
1  unb vs mod  1 0.2197101 2.463529 0.1334268   0.070      0.210    
2 unb vs high  1 0.5273956 9.416633 0.3704910   0.001      0.003   *
3 mod vs high  1 0.3936411 4.196178 0.2077709   0.018      0.054  

- The NMDS plot shows variation in community composition of small mammals, standardized by trapping effort. NMDS was performed on Bray-Curtis distances in three dimensions (stress = 0.09). Each circle represents a site, with the standard deviation of the centroids for each fire severity represented as color-coded ellipses (n = 9 for each). Community composition was significantly different between fire severity treatments (Adonis F(2,24) = 4.39, R^2^ = 0.268, p = 0.003). Post-hoc analysis by pairwise Adonis showed that community composition in unburned sites and high severity sites was significantly different (pairwise p = 0.006).

- Species codes:
    - SPBE = California ground squirrel
    - GLSA = northern flying squirrel
    - TAAM = yellow-pine chipmunk
    - TAQU = long-eared chipmunk
    - TASE = shadow chipmunk
    - NEFU = dusky-footed woodrat
    - PEMA = North American deer mouse
    - PEBO = brush mouse
    - PETR = Pinyon mouse
    - REME = western harvest mouse
    - SOTR = Trowbridge's shrew


- Considered using ANOSIM instead of Adonis, but Adonis is more robust because it is less sensitive to dispersion (also used betadisper to determine that dispersion was similar across treatments in order to satisfy assumptions of Adonis)

- PairwiseAdonis for moderate severity vs. high severity gave borderline p-value (p < 0.05 or p > 0.5 based on permutation)

- Ordination looked similar for both raw data and data adjusted for trapping effort

- Used three dimensions for NMDS in order to reduce stress (according to scree plot) and to avoid local minima (2 dimension nmds returned two solutions)

<br>

**Alternate NMDS plots using 2 dimensions (two local minima):**

```{r}

# 2 dimensions - option 1

par(mar = c(4,4,1,1))
plot(ord_adj_2dim, display = 'species',
     type = 'n')
points(ord_adj_2dim, display = 'sites',
       cex = 1.5, pch = 19, col = colors[matrix_adj_df$severity])
ordiellipse(ord_adj_2dim, groups = matrix_adj_df$severity,
            label = FALSE, col = colors, lwd = 2)
text(ord_adj_2dim, display = 'species',
     cex = 0.8)
title(main = 'NMDS in 2 dimensions')

# 2 dimensions - option 2

par(mar = c(4,4,1,1))
plot(ord_adj_2dim_2, display = 'species',
     type = 'n')
points(ord_adj_2dim_2, display = 'sites',
       cex = 1.5, pch = 19, col = colors[matrix_adj_df$severity])
ordiellipse(ord_adj_2dim_2, groups = matrix_adj_df$severity,
            label = FALSE, col = colors, lwd = 2)
text(ord_adj_2dim_2, display = 'species',
     cex = 0.8)
title(main = 'NMDS in 2 dimensions')

```

<br>

### Habitat drivers of community composition

**Individual habitat drivers of small mammal communities:**

```{r env nmds}

# Fit individual environmental variables

fit <- envfit(ord_adj_3dim, habitat_metrics[,3:16], permutations = 1000)

# NMDS plot with arrows for environmental variables

par(mar = c(4,4,1,1))
plot(ord_adj_3dim, display = 'sites',
     type = 'n')
points(ord_adj_3dim, display = 'sites',
       cex = 1.5, pch = 19, col = colors[matrix_adj_df$severity])
ordiellipse(ord_adj_3dim, groups = matrix_adj_df$severity, # by default plots ellipse with std error around centroids
            label = FALSE, col = colors, lwd = 2)
plot(fit,
     col = 'black', lwd = 3)

```

- The NMDS plot shows variation in community composition of small mammals, standardized by trapping effort. NMDS was performed on on Bray-Curtis distances in three dimensions (stress = 0.09). Each circle represents a site, with the standard deviation of the centroids for each fire severity represented as color-coded ellipses (n = 9 for each). Arrows represent the relative contributions of several possible habitat variables. Community composition was significantly different between fire severity treatments (Adonis F(2,24) = 4.39, R^2^ = 0.268, p = 0.003). Post-hoc analysis by pairwise Adonis showed that community composition in unburned sites and high severity sites was significantly different (pairwise p = 0.006).

- Appears to be fewer sites because some of them exactly overlap

- Habitat variables:
    - *avg_severity* - mean severity of pixels within the site, based on MTBS fire severity data (0-3 = unburned-high severity)
    - *dist_to_edge* - distance from the site center to the burn boundary (negative for sites outside the burn boundary)
    - *tree_bm* - density of adult tree biomass (live or dead) (kg/m^2^)
    - *shrub_bm* - density of live shrub biomass (kg/m^2^)
    - *grass_bm* - density of live grass biomass (kg/m^2^)
    - *forb_bm* - density of live forb biomass (kg/m^2^)
    - *tree_density* - density of trees (live or dead) (indv/m^2^)
    - *tree_survival* - proportion of live trees (%)
    - *veg_cover* - total proportion of vegetation cover (all species/life-forms - can sum to >100) (both transects) (%)
    - *litter_cover* - proportion of litter cover (%)
    - *cwd_volume* - density of coarse woody debris volume (m^3^/m^2^)
    - *tree_H* - Shannon diversity of adult trees
    - *shrub_H* - Shannon diversity of adult trees
    - *forb_H* - Shannon diversity of adult trees

<br>

**NMDS plot with PCA scores:**

```{r env nmds 2}

# Fit environmental variables

fit2 <- envfit(ord_adj_3dim, habitat_metrics[,17:19], permutations = 1000)

# NMDS plot with arrows for environmental variables

par(mar = c(4,4,1,1))
plot(ord_adj_3dim, xlim = c(-1.8,1.8), display = 'sites', type = 'n')
points(ord_adj_3dim, display = 'sites',
       cex = 1.5, pch = 19, col = colors[matrix_adj_df$severity])
ordiellipse(ord_adj_3dim, groups = matrix_adj_df$severity, # by default plots ellipse with std error around centroids
            label = FALSE, col = colors, lwd = 2)
plot(fit2,
     col = 'black', lwd = 3)
text(ord_adj_3dim, display = 'species',
     cex = 0.7, col = 'grey30')

```

- *fire_score* = avg_severity + dist_to_edge + tree_survival
- *biomass_score* = tree_bm + shrub_bm + grass_bm + forb_bm
- *diversity_score* = tree_H + shrub_H + forb_H

<br>

**NMDS plot with best variables from mvGLM:**

```{r model nmds}

# Data frame with only the variables from the model

model_vars <- habitat_metrics %>% 
  select(site, severity, tree_bm, shrub_bm, forb_bm, veg_cover, litter_cover, cwd_volume)

# Fit environmental variables

fit3 <- envfit(ord_adj_3dim, model_vars[,3:8], permutations = 1000)

fit3_2dim <- envfit(ord_adj_2dim, model_vars[,3:8], permutations = 1000)

# NMDS plot with arrows for environmental variables

par(mar = c(4,4,1,1))
plot(ord_adj_3dim, xlim = c(-1.8,1.2), diplay = 'sites', type = 'n')
points(ord_adj_3dim, display = 'sites',
       cex = 1, pch = 19, col = colors[matrix_adj_df$severity])
ordiellipse(ord_adj_3dim, groups = matrix_adj_df$severity, # by default plots ellipse with std error around centroids
            label = FALSE, col = colors, lwd = 2)
plot(fit3,
     col = 'black', lwd = 3, cex = 0.8)
text(ord_adj_3dim, display = 'species',
     cex = 0.7, col = 'grey30')

```

<br> 

**Clean NMDS plots with ggplot:**

*NMDS in 3 dimensions*

```{r, include=FALSE}

# Ordination plot with ggplot

# Data frames with point and vector information

NMDS <- fortify(ord_adj_3dim) %>% 
  filter(Score == 'sites') %>% 
  full_join(sevs, by = c('Label' = 'site')) %>% 
  dplyr::rename(group = severity)


spp_points <- fortify(ord_adj_3dim) %>% 
  filter(Score == 'species') %>% 
  mutate(Label = as.character(Label),
         Label2 = case_when(
           Label == 'SPBE' ~ 'OTBE',
           Label == 'TAAM' ~ 'NEAM',
           Label == 'TAQU' ~ 'NEQU',
           Label == 'TASE' ~ 'NETA',
           TRUE ~ Label
           ))

vectors <- fortify(fit3) %>% 
  mutate(xend = NMDS1*2.75,
         yend = NMDS2*2.75,
         xlab = case_when(
           Label == 'tree_bm' ~ xend - 0.4,
           Label == 'shrub_bm' ~ xend + 0.45,
           Label == 'forb_bm' ~ xend + 0.4,
           Label == 'veg_cover' ~ xend + 0.55,
           Label == 'litter_cover' ~ xend - 0.4,
           Label == 'cwd_volume' ~ xend + 0.4
         ),
         ylab = case_when(
           Label == 'tree_bm' ~ yend + 0.13,
           Label == 'shrub_bm' ~ yend + 0.1,
           Label == 'forb_bm' ~ yend + 0.1,
           Label == 'veg_cover' ~ yend + 0.05,
           Label == 'litter_cover' ~ yend + 0.02,
           Label == 'cwd_volume' ~ yend + 0.1
         ),
         lab = case_when(
           Label == 'tree_bm' ~ 'Tree biomass',
           Label == 'shrub_bm' ~ 'Shrub biomass',
           Label == 'forb_bm' ~ 'Forb biomass',
           Label == 'veg_cover' ~ 'Understory cover',
           Label == 'litter_cover' ~ 'Litter cover',
           Label == 'cwd_volume' ~ 'CWD volume'
         ))

# Data frame with ellipse information

plot.new()
ord <- ordiellipse(ord_adj_3dim, groups = sevs$severity)

veganCovEllipse<-function (cov, center = c(0, 0), scale = 1, npoints = 100) 
  {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
  }

df_ell <- data.frame()

for(g in levels(NMDS$group)){
  df_ell <- rbind(df_ell, cbind(as.data.frame(with(NMDS[NMDS$group==g,],
                  veganCovEllipse(ord[[g]]$cov,ord[[g]]$center,ord[[g]]$scale)))
                                ,group=g))
}

```

```{r}

# ggplot in 3 dimensions

ggplot() +
  geom_path(data = df_ell,
            aes(x = NMDS1, y = NMDS2, color = group),
            size = 1) +
  geom_point(data = NMDS,
             aes(x = NMDS1, y = NMDS2, color = group),
             size = 2) +
  # geom_text(data = spp_points,
  #           aes(x = NMDS1, y = NMDS2, label = Label2),
  #           size = 3, color = 'grey40') +
  geom_segment(data = vectors[c(4,5,6),],
               aes(x = 0, y = 0, xend = xend, yend = yend),
               arrow = arrow(length = unit(0.02, 'npc'), type = 'closed'),
               size = 0.7) +
  # geom_segment(data = vectors[5,],
  #              aes(x = 0, y = 0, xend = xend, yend = yend),
  #              arrow = arrow(length = unit(0.03, 'npc'), type = 'closed'),
  #              size = 0.9) +
  geom_text(data = vectors[c(4,5,6),],
            aes(x = xlab, y = ylab, label = lab),
            size = 4) +
  # geom_text(data = vectors[5,],
  #           aes(x = xlab, y = ylab, label = lab),
  #           size = 4, fontface = 'bold') +
  geom_label(data = NMDS, aes(x = -1.5, y = 1.1, label = 'NMDS in 3 dim\n(2 dim displayed)\nstress = 0.09')) +
  scale_color_manual(values = c('darkgreen', 'orange', 'red')) +
  scale_x_continuous(limits = c(-1.9,1.7)) +
  scale_y_continuous(limits = c(-0.7,1.3)) +
  theme_classic() +
  theme(panel.border = element_rect(fill = NA),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        legend.position = 'none') +
  coord_fixed()

ggsave('figs/fig5b.png', plot = last_plot(),
       width = 5, height = 3, units = 'in')

```

<br>

*NMDS in 2 dimensions*

```{r, include=FALSE}

# SAME GRAPH BUT ON TWO DIMENSIONS

# Ordination plot with ggplot

# With ggplot

# Data frames with point and vector information

NMDS <- fortify(ord_adj_2dim) %>% 
  filter(Score == 'sites') %>% 
  full_join(sevs, by = c('Label' = 'site')) %>% 
  dplyr::rename(group = severity)


spp_points <- fortify(ord_adj_2dim) %>% 
  filter(Score == 'species') %>% 
  mutate(Label = as.character(Label),
         Label2 = case_when(
           Label == 'SPBE' ~ 'OTBE',
           Label == 'TAAM' ~ 'NEAM',
           Label == 'TAQU' ~ 'NEQU',
           Label == 'TASE' ~ 'NETA',
           TRUE ~ Label
           ))

vectors <- fortify(fit3_2dim) %>% 
  mutate(xend = NMDS1*2.75,
         yend = NMDS2*2.75,
         xlab = case_when(
           Label == 'tree_bm' ~ xend - 0.42,
           Label == 'shrub_bm' ~ xend + 0.5,
           Label == 'forb_bm' ~ xend + 0.4,
           Label == 'veg_cover' ~ xend + 0.57,
           Label == 'litter_cover' ~ xend - 0.43,
           Label == 'cwd_volume' ~ xend -0.43
         ),
         ylab = case_when(
           Label == 'tree_bm' ~ yend + 0.1,
           Label == 'shrub_bm' ~ yend + 0.09,
           Label == 'forb_bm' ~ yend + 0.1,
           Label == 'veg_cover' ~ yend + 0.02,
           Label == 'litter_cover' ~ yend + 0.07,
           Label == 'cwd_volume' ~ yend + 0.1
         ),
         lab = case_when(
           Label == 'tree_bm' ~ 'Tree biomass',
           Label == 'shrub_bm' ~ 'Shrub biomass',
           Label == 'forb_bm' ~ 'Forb biomass',
           Label == 'veg_cover' ~ 'Understory cover',
           Label == 'litter_cover' ~ 'Litter cover',
           Label == 'cwd_volume' ~ 'CWD volume'
         ))

# Data frame with ellipse information

plot.new()
ord <- ordiellipse(ord_adj_2dim, groups = sevs$severity)

veganCovEllipse<-function (cov, center = c(0, 0), scale = 1, npoints = 100) 
  {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
  }

df_ell <- data.frame()

for(g in levels(NMDS$group)){
  df_ell <- rbind(df_ell, cbind(as.data.frame(with(NMDS[NMDS$group==g,],
                  veganCovEllipse(ord[[g]]$cov,ord[[g]]$center,ord[[g]]$scale)))
                                ,group=g))
}

```


```{r}

# ggplot in 2 dimensions

ggplot() +
  geom_path(data = df_ell,
            aes(x = NMDS1, y = NMDS2, color = group),
            size = 1) +
  geom_point(data = NMDS,
             aes(x = NMDS1, y = NMDS2, color = group),
             size = 2) +
  # geom_text(data = spp_points,
  #           aes(x = NMDS1, y = NMDS2, label = Label2),
  #           size = 3, color = 'grey40') +
  geom_segment(data = vectors[c(3,4,6,
                                1,2,5),],
               aes(x = 0, y = 0, xend = xend, yend = yend),
               arrow = arrow(length = unit(0.02, 'npc'), type = 'closed'),
               size = 0.7) +
  # geom_segment(data = vectors[5,],
  #              aes(x = 0, y = 0, xend = xend, yend = yend),
  #              arrow = arrow(length = unit(0.03, 'npc'), type = 'closed'),
  #              size = 0.9) +
  geom_text(data = vectors[c(3,4,6,
                             1,2,5),],
            aes(x = xlab, y = ylab, label = lab),
            size = 4) +
  # geom_text(data = vectors[5,],
  #           aes(x = xlab, y = ylab, label = lab),
  #           size = 4, fontface = 'bold') +
  scale_color_manual(values = c('darkgreen', 'orange', 'red')) +
  scale_x_continuous(limits = c(-1.8, 1.7)) +
  scale_y_continuous(breaks = c(0, 1)) +
  theme_classic() +
  theme(panel.border = element_rect(fill = NA),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        legend.position = 'none') +
  coord_fixed()

```

```{r eval=FALSE}

rmarkdown::render('code/08_nmds.Rmd', output_file = '../docs/08_nmds.html')

```
