---
title: "Multivariate GLM"
author: "Kate Culhane"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = '..')
knitr::opts_chunk$set(include = FALSE, warning = FALSE, message = FALSE,
                      fig.width=7, fig.height=5)
```

<br>

```{r packages and data, include=FALSE}

# Load packages

library(tidyverse)
# library(ggbiplot)
# library(randomForest)
# library(packfor)
library(mvabund)
# library(corrplot)
library(vegan)

# Update functions

# rename <- dplyr::rename
# select <- dplyr::select

# Load data

matrix_df <- read_csv('output_data/species_matrix.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

veg_metrics <- read_csv('output_data/veg_metrics.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

site_centroids <- read_csv('output_data/site_centroids.csv')

# diversity <- read_csv('output_data/diversity.csv') %>% 
#   mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

```

```{r pcnm}

# Principle Components of Neighborhood Matrix (PCNM)

site_pcnm <- pcnm(dist(site_centroids[,2:3]))

pcnm_vectors <- as.data.frame(site_pcnm$vectors) %>% 
  cbind(site_centroids$sites_aea.site)%>% 
  rename(site = 'site_centroids$sites_aea.site',
         pcnm_1 = PCNM1) %>% 
  select(site, pcnm_1)

# All predictor variables

vars <- full_join(veg_metrics[,c(1:4,7,9)], pcnm_vectors)

```

### Multivariate GLM

Misc. resources:
http://eco-stats.blogspot.com/2012/03/introducing-mvabund-package-and-why.html
https://www.dropbox.com/s/unwd412a9wbkrl0/mvabundTute.R?dl=0
https://rdrr.io/cran/mvabund/man/anova.manyglm.html
http://www.seec.uct.ac.za/sites/default/files/image_tool/images/330/SEEC%20Toolbox%20mvabund.pdf

Whether to use anova() or summary(): https://stats.stackexchange.com/questions/59879/logistic-regression-anova-chi-square-test-vs-significance-of-coefficients-ano
Wald vs score statistic:https://stats.idre.ucla.edu/other/mult-pkg/faq/general/faqhow-are-the-likelihood-ratio-wald-and-lagrange-multiplier-score-tests-different-andor-similar/

**Hypothesis predictor variables:**

- *Cover resources:*
  - Shrub cover
  - Loose litter cover
  - Live tree density
  - "Random effect" - Principle Components of Neighborhood Matrix (PCNM)

```{r}

# Create mvabund object using species matrix
dat <- full_join(vars, matrix_df)
spp <- mvabund(dat[,8:18])

# Compare relationship between means and variances
meanvar.plot(spp) # looks like a linear increase...
# need to use appropriate GLM that assumes a similar mean-variance relationship
# negative binomial distribution is best for a linear mean-variance relationship

plot(data=dat, spp~severity)

```

<br>

### Severity effects

```{r}

# Test for differences by severity/block
# Does treatment have an effect on assemblage?
# anova() determines which predictors are the strongest contributors by sequentially adding them to the restricted (less variables) model (for test=score)
# (confirming the adonis results and nmds visualization)
set.seed(7)
glm <- manyglm(data=dat, spp~severity*block,
               family='negative_binomial')
plot(glm)
coef(glm)
set.seed(7)
an <- anova(glm,
            test='score', # use score statistic since means are small because of rare species, which decreases power in the Wald statistic
            cor.type='R', # accounts for correlation between variables, can be used because N (number of observations) >  p (number of variables)
            nBoot=999)
an$table

```

                   Res.Df Df.diff score Pr(>score)  
    (Intercept)        26                           
    severity           24       2 29.76      0.048 *
    block              22       2 21.63      0.075 .
    severity:block     18       4 35.98      0.083 .

<br>

### Indicator species

```{r}

# Test univariate (species) differences by severity/block
# What are the indicator species?
set.seed(7)
an2 <- anova(glm, test='score', cor.type='R', nBoot=999, p.uni='adjusted')
an2

```

                    GLSA             NEAM             NEFU             NEQU           
                   score Pr(>score) score Pr(>score) score Pr(>score) score Pr(>score)
    severity           4      0.326 1.075      0.921 2.243      0.781 1.615      0.921
    block              4      0.563 2.677      0.732 2.782      0.732 1.876      0.841
    severity:block     0      0.766     0      0.766 0.286      0.705 4.434      0.395

                    NESE             OTBE             PEBO              PEMA           
                   score Pr(>score) score Pr(>score) score Pr(>score)  score Pr(>score)
    severity       1.973      0.921 1.566      0.921 3.692      0.459 11.043      0.011
    block          2.654      0.732 3.126      0.719 2.826      0.732  6.897      0.097
    severity:block 0.565      0.705 5.405      0.269  6.88      0.194  9.343      0.160

                    PETR             REME             SOTR           
                   score Pr(>score) score Pr(>score) score Pr(>score)
    severity           1      0.921 1.197      0.921 9.766      0.011
    block              1      0.860 1.337      0.860 1.131      0.860
    severity:block     2      0.406     0      0.706 3.537      0.395

<br>

### Vegetation drivers

```{r}

# Test vegetation variables
# Which environmental variables are most strongly associated with assemblages?
# summary() determines which predictors are the strongest contributors when all other predictors have been fitted to the restricted (less variables) model (for test=score)
set.seed(7)
glm2 <- manyglm(data=dat, spp~live_tree_density+loose_cover+shrub_cover,
               family='negative_binomial')
plot(glm2)
coef(glm2)
set.seed(7)
sum <- summary(glm2, test='score', cor.type='R', nBoot=999)
sum$coefficients
sum$statistic

```

                      score value Pr(>score)
    (Intercept)          33.56357      0.016
    shrub_cover          17.24493      0.033
    loose_cover          13.02669      0.217
    live_tree_density    17.08897      0.036

    Test statistic:  47.03, p-value: 0.034 

<br>

### Traits

SHOULD I ALSO DO THIS FOR TRAITS?!
https://rpubs.com/dwarton/68823

```{r eval=FALSE}
rmarkdown::render('code/09_mvglm.Rmd', output_file = '../docs/09_mvglm.html')
```

