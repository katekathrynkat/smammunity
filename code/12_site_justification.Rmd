---
title: "Site Justification"
author: "Kate Culhane"
date: "January 6, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = '..')
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width=5, fig.height=3)
```

```{r packages & data}

# Load necessary packages

library(tidyverse)
library(cowplot) # plot_grid function
library(dunn.test)
library(ggbiplot)

# Update functions

rename <- dplyr::rename
summarize <- dplyr::summarize
mutate <- dplyr::mutate

# Load necessary data

spatial <- read_csv('output_data/spatial_metrics.csv')

veg <- read_csv('output_data/veg_metrics.csv')

crosswalk <- read_csv('raw_data/spatial_data/crosswalk.csv')

evt_data <- read_csv('output_data/EVT_2012.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))
evt_data2 <- read_csv('output_data/EVT_2014.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))
evt_meta <- read_csv('raw_data/spatial_data/EVT_attributes.csv')

evc_data <- read_csv('output_data/EVC_2012.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))
evc_data2 <- read_csv('output_data/EVC_2014.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))
evc_meta <- read_csv('raw_data/spatial_data/EVC_attributes.csv')

```

<br>

### Pre-disturbance metrics

#### Existing Vegetation Type and Existing Vegetation Cover

```{r, include=FALSE}

# EVT (Existing Vegetation Type)

# 2012 (pre-disturbance)

evt <- evt_data %>% 
  group_by(severity) %>% 
  mutate(total = sum(n)) %>% 
  group_by(severity, evt) %>% 
  mutate(persev = sum(n),
         prop = persev/total) %>% 
  filter(prop > 0.01) %>% # delete habitats that represent <1% of habitat sampled for each severity
  summarize(sum = sum(n)) %>% 
  inner_join(evt_meta, by = c('evt' = 'VALUE')) # add metadata

# 2014 (post-disturbance)

evt2 <- evt_data2 %>% 
  group_by(severity) %>% 
  mutate(total = sum(n)) %>% 
  group_by(severity, evt) %>% 
  mutate(persev = sum(n),
         prop = persev/total) %>% 
  filter(prop > 0.01) %>% # delete habitats that represent <1% of habitat sampled for each severity
  summarize(sum = sum(n)) %>% 
  inner_join(evt_meta, by = c('evt' = 'VALUE')) # add metadata

```

```{r, include=FALSE}

# EVT before vs. after

sev.labs <- c("Unburned", "Low-Mod.\nSeverity", "High\nSeverity")
names(sev.labs) <- c("unb", "mod", "high")

evt_plot <- full_join(evt, evt2, by = c('severity', 'CLASSNAME')) %>% 
  rename('2012' = sum.x, '2014' = sum.y, EVT = CLASSNAME) %>% 
  select(severity, EVT, '2012', '2014') %>% 
  mutate(EVT = factor(EVT, levels = c('Mediterranean California Dry-Mesic Mixed Conifer Forest and Woodland',
                                      'Mediterranean California Mesic Mixed Conifer Forest and Woodland',
                                      'California Montane Jeffrey Pine(-Ponderosa Pine) Woodland',
                                      'Mediterranean California Red Fir Forest',
                                      'California Montane Riparian Systems',
                                      'California Montane Woodland and Chaparral',
                                      'North Pacific Montane Grassland'))) %>% 
  gather(year, pixels, 3:4) %>% 
  ggplot(aes(x = year, y = pixels, fill = EVT)) +
    geom_bar(position = 'fill', stat = 'identity') +
    scale_fill_manual(name = 'Vegetation Type',
                      values = c('#9C9C00','#696900','#1DA300','#136700',
                                 '#6baed6',
                                 '#8c2d04','#fe9929'),
                      labels = c('Dry-mesic mixed conifer forest',
                                 'Mesic mixed conifer forest',
                                 'Montane yellow pine woodland',
                                 'Red fir forest',
                                 'Montane riparian system',
                                 'Montane woodland and chaparral',
                                 'Montane grassland')) +
    labs(y = 'EVT (% of pixels)') +
    scale_y_continuous(expand = c(0,0),
                       labels = c(0,25,50,75,100)) +
    theme_classic() +
    theme(axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_text(size = 14),
          axis.text.x = element_blank(),
          axis.text.y = element_text(size = 12, color = 'black'),
          legend.justification = c(0,0.5),
          strip.text.x = element_text(size = 10, face = 'bold'),
          plot.margin = unit(c(5,5,5,20), 'pt')) +
  expand_limits(y = 1.1) +
  facet_wrap(~severity,
             labeller = labeller(severity = sev.labs))

```

```{r, include=FALSE}

# ANOTHER ARRANGEMENT

year.labs <- c("2012\nPre-Fire", "2014\nPost-Fire")
names(year.labs) <- c("2012", "2014")

evt_plot2 <- full_join(evt, evt2, by = c('severity', 'CLASSNAME')) %>% 
  rename('2012' = sum.x, '2014' = sum.y, EVT = CLASSNAME) %>% 
  select(severity, EVT, '2012', '2014') %>% 
  mutate(EVT = factor(EVT, levels = c('Mediterranean California Dry-Mesic Mixed Conifer Forest and Woodland',
                                      'Mediterranean California Mesic Mixed Conifer Forest and Woodland',
                                      'California Montane Jeffrey Pine(-Ponderosa Pine) Woodland',
                                      'Mediterranean California Red Fir Forest',
                                      'California Montane Riparian Systems',
                                      'California Montane Woodland and Chaparral',
                                      'North Pacific Montane Grassland'))) %>% 
  gather(year, pixels, 3:4) %>% 
  ggplot(aes(x = severity, y = pixels, fill = EVT)) +
    geom_bar(position = 'fill', stat = 'identity') +
    scale_fill_manual(name = 'Vegetation Type',
                      values = c('#9C9C00','#696900','#1DA300','#136700',
                                 '#6baed6',
                                 '#8c2d04','#fe9929'),
                      labels = c('Dry-mesic mixed conifer forest',
                                 'Mesic mixed conifer forest',
                                 'Montane yellow pine woodland',
                                 'Red fir forest',
                                 'Montane riparian system',
                                 'Montane woodland and chaparral',
                                 'Montane grassland')) +
    labs(y = 'EVT (% of pixels)') +
    scale_y_continuous(expand = c(0,0),
                       labels = c(0,25,50,75,100)) +
    theme_classic() +
    theme(axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_text(size = 14),
          axis.text.x = element_blank(),
          axis.text.y = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 10),
          legend.justification = c(0,0),
          strip.text.x = element_text(size = 12, face = 'bold'),
          plot.margin = unit(c(5,5,5,20), 'pt')) +
  expand_limits(y = 1.1) +
  facet_wrap(~year,
             labeller = labeller(year = year.labs))

```

```{r, include=FALSE}

# EVC (Existing Vegetation Cover)

# 2012 (pre-disturbance)

evc <- evc_data %>% 
  group_by(severity) %>%
  mutate(total = sum(n)) %>% 
  group_by(severity, evc) %>% 
  mutate(persev = sum(n),
         prop = persev/total) %>% 
  filter(prop > 0.01) %>% # delete habitats that represent <1% of habitat sampled
  summarize(sum = sum(n)) %>% 
  inner_join(evc_meta, by = c('evc' = 'VALUE')) # add metadata

# 2014 (post-disturbance)

evc2 <- evc_data2 %>% 
  group_by(severity) %>%
  mutate(total = sum(n)) %>% 
  group_by(severity, evc) %>% 
  mutate(persev = sum(n),
         prop = persev/total) %>% 
  filter(prop > 0.01) %>% # delete habitats that represent <1% of habitat sampled
  summarize(sum = sum(n)) %>% 
  inner_join(evc_meta, by = c('evc' = 'VALUE')) # add metadata

```

```{r, include=FALSE}

# EVC before vs. after

evc_plot <- full_join(evc, evc2, by = c('severity', 'CLASSNAMES')) %>% 
  rename('2012' = sum.x, '2014' = sum.y, EVC = CLASSNAMES) %>% 
  select(severity, EVC, '2012', '2014') %>% 
  gather(year, pixels, 3:4) %>% 
  ggplot(aes(x = year, y = pixels, fill = EVC)) +
    geom_bar(position = 'fill', stat = 'identity') +
    scale_fill_manual(name = 'Vegetation Cover',
                      values = c('#9ecae1','#fdae6b',
                                 '#c7e9c0','#a1d99b','#74c476','#41ab5d','#238b45','#005a32'),
                      labels = c('Forb: 20-30%',
                                 'Shrub: 50-60%',
                                 'Tree: 20-30%','Tree: 30-40%','Tree: 40-50%',
                                 'Tree: 50-60%','Tree: 60-70%','Tree: 70-80%')) +
    labs(y = 'EVC (% of pixels)') +
    scale_y_continuous(expand = c(0,0),
                       labels = c(0,25,50,75,100)) +
    theme_classic() +
    theme(axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_text(size = 14),
          axis.text.x = element_text(size = 12, color = 'black', angle = 90, vjust = 0.5),
          axis.text.y = element_text(size = 12, color = 'black'),
          strip.background = element_blank(),
          strip.text.x = element_blank(),
          legend.justification = c(0,0.5),
          plot.margin = unit(c(5,5,5,20), 'pt')) +
  expand_limits(y = 1.1) +
  facet_wrap(~severity)

```


```{r, include=FALSE}

# ANOTHER ARRANGEMENT

evc_plot2 <- full_join(evc, evc2, by = c('severity', 'CLASSNAMES')) %>% 
  rename('2012' = sum.x, '2014' = sum.y, EVC = CLASSNAMES) %>% 
  select(severity, EVC, '2012', '2014') %>% 
  gather(year, pixels, 3:4) %>% 
  ggplot(aes(x = severity, y = pixels, fill = EVC)) +
    geom_bar(position = 'fill', stat = 'identity') +
    scale_fill_manual(name = 'Vegetation Cover',
                      values = c('#ffce8a','#e89a61',
                                 '#c7e9c0','#a1d99b','#74c476','#41ab5d','#238b45','#005a32'),
                      labels = c('Forb: 20-30%',
                                 'Shrub: 50-60%',
                                 'Tree: 20-30%','Tree: 30-40%','Tree: 40-50%',
                                 'Tree: 50-60%','Tree: 60-70%','Tree: 70-80%')) +
    labs(y = 'Proportional Area') +
  scale_x_discrete(labels = c('Unburned', 'Low-Mod.\nSeverity', 'High\nSeverity')) +
    scale_y_continuous(expand = c(0,0),
                       labels = c(0,25,50,75,100)) +
    theme_classic() +
    theme(axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_text(size = 12),
          axis.text.x = element_text(size = 11, color = 'black', angle = 90, vjust = 0.5),
          axis.text.y = element_text(size = 11, color = 'black'),
          legend.text = element_text(size = 11),
          strip.background = element_blank(),
          strip.text.x = element_blank(),
          legend.justification = c(0,1),
          plot.margin = unit(c(5,5,5,20), 'pt')) +
  expand_limits(y = 1.1) +
  facet_wrap(~year)

```

```{r, fig.height=5.5, fig.width=6}

plot_grid(evt_plot, evc_plot,
          ncol = 1, align = 'v',
          rel_heights = c(1, 1))

plot_grid(evt_plot2, evc_plot2,
          ncol = 1, align = 'v',
          rel_heights = c(1, 1.1))

```

#### California Wildlife Habitat Relationships

```{r}

# Crosswalking from EVT to CWHR data

cwhr_data <- left_join(evt_data, crosswalk)
cwhr_data2 <- left_join(evt_data2, crosswalk)

# 2012 (pre-disturbance)

cwhr <- cwhr_data %>% 
  group_by(severity) %>% 
  mutate(total = sum(n)) %>% 
  group_by(severity, cwhr) %>% 
  mutate(persev = sum(n),
         prop = persev/total) %>% 
  filter(prop > 0.01) %>% # delete habitats that represent <1% of habitat sampled for each sev
  summarize(sum = sum(n))

# 2014 (post-disturbance)

cwhr2 <- cwhr_data2 %>% 
  group_by(severity) %>% 
  mutate(total = sum(n)) %>% 
  group_by(severity, cwhr) %>% 
  mutate(persev = sum(n),
         prop = persev/total) %>% 
  filter(prop > 0.01) %>% # delete habitats that represent <1% of habitat sampled for each sev
  summarize(sum = sum(n))

```


```{r, include=FALSE}

# PLOT

year.labs <- c("2012\nPre-Fire", "2014\nPost-Fire")
names(year.labs) <- c("2012", "2014")

cwhr_plot <- full_join(cwhr, cwhr2, by = c('severity', 'cwhr')) %>% 
  rename('2012' = sum.x, '2014' = sum.y) %>% 
  select(severity, cwhr, '2012', '2014') %>% 
  mutate(cwhr = factor(cwhr, levels = c('Montane chaparral',
                                        'Perennial grassland',
                                        'Montane riparian',
                                        'Ponderosa pine/Jeffrey pine/Eastside pine',
                                        'Red fir',
                                        'Sierran mixed conifer forest/White fir/Douglas fir'))) %>%
  gather(year, pixels, 3:4) %>% 
  ggplot(aes(x = severity, y = pixels, fill = cwhr)) +
    geom_bar(position = 'fill', stat = 'identity') +
    scale_fill_manual(name = 'CWHR Habitat Type',
                      values = c('#DD9C33', '#EDDB3B', '#6baed6',
                                 '#79BC2D', '#6F8932', '#ACBA2E'),
                      labels = c('Montane chaparral',
                                 'Perennial grassland',
                                 'Montane riparian',
                                 'Ponderosa/Jeffrey pine',
                                 'Red fir',
                                 'Sierran mixed conifer forest')) +
    labs(y = 'Proportional Area') +
    scale_y_continuous(expand = c(0,0),
                       labels = c(0,25,50,75,100)) +
    theme_classic() +
    theme(axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_text(size = 12),
          axis.text.x = element_blank(),
          axis.text.y = element_text(size = 11, color = 'black'),
          legend.text = element_text(size = 11),
          legend.justification = c(0,1),
          strip.text.x = element_text(size = 11, face = 'bold'),
          plot.margin = unit(c(5,5,5,20), 'pt')) +
  expand_limits(y = 1.1) +
  facet_wrap(~year,
             labeller = labeller(year = year.labs))

```


```{r, fig.height=5.5, fig.width=6}

plot_grid(cwhr_plot, evc_plot2,
          ncol = 1, align = 'v',
          rel_heights = c(1, 1.1))

ggsave('figs/fig1C.png', plot = last_plot(),
       width = 6, height = 5.5, units = 'in')

```

<br>

### Post-disturbance metrics

**Fire severity metrics for the three severity categories:**

```{r, fig.height=6, fig.width=4}

# Summarize metrics by severity

metrics <- full_join(spatial, veg) %>%
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')),
         tree_mortality = case_when(
           severity == 'unb' ~ 0,
           TRUE ~ (1-tree_survival)*100
         ),
         dist_to_edge = dist_to_edge/1000) %>% 
  select(site, severity, avg_pixel, dist_to_edge, tree_mortality)

metrics_summary <- metrics %>% 
  group_by(severity) %>% 
  dplyr::summarize(avg_pixel_mean = mean(avg_pixel),
                   avg_pixel_se = sd(avg_pixel)/sqrt(length(avg_pixel)),
                   dist_to_edge_mean = mean(dist_to_edge),
                   dist_to_edge_se = sd(dist_to_edge)/sqrt(length(dist_to_edge)),
                   tree_mortality_mean = mean(tree_mortality),
                   tree_mortality_se = sd(tree_mortality)/sqrt(length(tree_mortality)))

# Plot metrics by severity

avg_pixel_plot <- ggplot(metrics_summary) +
  geom_col(aes(x = severity, y = avg_pixel_mean, fill = severity)) +
  scale_fill_manual(values = c('darkgreen', 'orange', 'red')) +
  geom_hline(yintercept = 0) +
  geom_errorbar(aes(x = severity,
                    ymin = avg_pixel_mean-avg_pixel_se,
                    ymax = avg_pixel_mean+avg_pixel_se),
                width=.15) +
  labs(y = 'MTBS Severity') +
  theme_classic() +
  theme(axis.title.x = element_blank(),
        legend.position = 'none',
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = unit(c(5,5,5,20), 'pt'))

tree_mortality_plot <- ggplot(metrics_summary) +
  geom_col(aes(x = severity, y = tree_mortality_mean, fill = severity)) +
  scale_fill_manual(values = c('darkgreen', 'orange', 'red')) +
  geom_errorbar(aes(x = severity,
                    ymin = tree_mortality_mean-tree_mortality_se,
                    ymax = tree_mortality_mean+tree_mortality_se),
                width=.15) +
  labs(y = '% Tree Mortality') +
  scale_x_discrete(labels = c('Unburned', 'Moderate\nSeverity', 'High\nSeverity')) +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() +
  theme(axis.title.x = element_blank(),
        legend.position = 'none',
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        plot.margin = unit(c(5,5,5,20), 'pt'))

dist_to_edge_plot <- ggplot(metrics_summary) +
  geom_col(aes(x = severity, y = dist_to_edge_mean, fill = severity)) +
  scale_fill_manual(values = c('darkgreen', 'orange', 'red')) +
  geom_errorbar(aes(x = severity,
                    ymin = dist_to_edge_mean-dist_to_edge_se,
                    ymax = dist_to_edge_mean+dist_to_edge_se),
                width=.15) +
  geom_hline(yintercept = 0) +
  labs(y = 'Dist to edge (km)') +
  scale_x_discrete(labels = c('Unburned', ' Low-Mod\n Severity', 'High\nSeverity')) +
  theme_classic() +
  theme(axis.title.x = element_blank(),
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = 'none',
        plot.margin = unit(c(5,5,5,20), 'pt'))

plot_grid(avg_pixel_plot, tree_mortality_plot, dist_to_edge_plot,
          labels = "AUTO",
          ncol = 1, align = 'v',
          rel_heights = c(1, 1, 1.3))

```

```{r, eval=FALSE}

# Kruskal Wallis

kruskal.test(avg_pixel ~ severity, data = metrics) # p<0.05
kruskal.test(tree_mortality ~ severity, data = metrics) # p<0.05
kruskal.test(dist_to_edge ~ severity, data = metrics) # p<0.05

# Post-hoc pairwise testing with Dunn's test with Bonferroni correction

dunn.test(metrics$avg_pixel, metrics$severity, method = 'bonferroni') # p<0.05 for all
dunn.test(metrics$tree_mortality, metrics$severity, method = 'bonferroni') # p<0.05 for all
dunn.test(metrics$dist_to_edge, metrics$severity, method = 'bonferroni') # p<0.05 for unb vs. high, unb vs. mod


```

- All differences significant for average MTBS severity and % tree mortality (Kruskal Wallis, post-hoc by Dunn's test with Bonferroni correction, $\alpha$ = 0.05)
- Differences in distance-to-edge significant for unburned vs high and unburned vs moderate only

<br>

**Final figure (without dist-to-edge):**

```{r, fig.width=4, fig.height=5}

# Plot metrics by severity WITHOUT dist-to-edge

avg_pixel_plot <- ggplot(metrics_summary) +
  geom_col(aes(x = severity, y = avg_pixel_mean, fill = severity)) +
  scale_fill_manual(values = c('darkgreen', 'orange', 'red')) +
  geom_hline(yintercept = 0) +
  geom_errorbar(aes(x = severity,
                    ymin = avg_pixel_mean-avg_pixel_se,
                    ymax = avg_pixel_mean+avg_pixel_se),
                width=.15) +
  labs(y = 'MTBS Severity') +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() +
  theme(axis.title.x = element_blank(),
        legend.position = 'none',
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 12, color = 'black'),
        plot.margin = unit(c(10,5,5,20), 'pt'))

tree_mortality_plot <- ggplot(metrics_summary) +
  geom_col(aes(x = severity, y = tree_mortality_mean, fill = severity)) +
  scale_fill_manual(values = c('darkgreen', 'orange', 'red')) +
  geom_errorbar(aes(x = severity,
                    ymin = tree_mortality_mean-tree_mortality_se,
                    ymax = tree_mortality_mean+tree_mortality_se),
                width=.15) +
  labs(y = '% Tree Mortality') +
  scale_x_discrete(labels = c('Unburned', ' Low-Mod.\n Severity', 'High\nSeverity')) +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() +
  theme(legend.position = 'none',
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_text(size = 14),
        axis.text.x = element_text(size = 10, color = 'black'),
        axis.text.y = element_text(size = 12, color = 'black'),
        plot.margin = unit(c(10,5,5,20), 'pt'))

plot_grid(avg_pixel_plot, tree_mortality_plot,
          ncol = 1, align = 'v',
          rel_heights = c(1, 1))

ggsave('figs/fig1D.png', plot = last_plot(),
       width = 3, height = 4, units = 'in')

```

<br>

### PCA of the three severity metrics

```{r, fig.height=5}

# PCA of the three severity metrics

severity_pca <- prcomp(metrics[c(3:5)],
                       scale = TRUE)

ggbiplot(severity_pca, groups = metrics$severity) + # PC1 describes 88% of the variance
  scale_color_manual(values = c('darkgreen', 'orange', 'red')) +
  theme_classic() +
  theme(legend.position = 'none')

```

<br>

**Number lines showing the 27 sites by severity metrics:**

```{r, fig.height=1}

# Number lines of the severity groups

severity_scores <- data.frame(severity_pca$x) %>% 
  bind_cols(metrics) %>% 
  select(site, severity, severity_score = PC1)

ggplot(severity_scores, aes(x = severity_score, y = 1, color = severity)) +
  geom_point() +
  scale_color_manual(values = c('darkgreen', 'orange', 'red')) +
  labs(x = 'Severity PCA Score', y = '') +
  theme_void() +
  theme(axis.title = element_text(),
        axis.line.x = element_line(),
        axis.text.x = element_text())

ggplot(metrics, aes(x = avg_pixel, y = 1, color = severity)) +
  geom_point() +
  scale_color_manual(values = c('darkgreen', 'orange', 'red')) +
  labs(x = 'Average MTBS Pixel', y = '') +
  theme_void() +
  theme(axis.title = element_text(),
        axis.line.x = element_line(),
        axis.text.x = element_text())

```

```{r eval=FALSE}

rmarkdown::render('code/12_site_justification.Rmd', output_file = '../docs/12_site_justification.html')

```
