---
title: "Abundance Analyses"
author: "Kate Culhane"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = '..')
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width=5, fig.height=3)
```

<br>

```{r packages and data}

# Load packages

library(tidyverse)
library(rstatix)
library(ggpubr)
library(effectsize)
library(dunn.test)
library(kableExtra)
library(calecopal)
library(fishmethods) # for Schnabel's estimate

# Load data

smamms <- read_csv('output_data/unique_smamms.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

captures <- read_csv('output_data/smamms.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

effort <- read_csv('output_data/effort.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

# Vectors for ggplot

cols <- c('darkgreen', 'orange', 'red')
xlabs <- c('Unburned', 'Moderate Severity', 'High Severity') 

```

```{r}

# Calculate total abundance summed across all species at each site (raw and adjusted)

abundance <- smamms %>% 
  group_by(site, severity) %>% 
  tally() %>% # count individuals per site
  full_join(effort) %>% 
  mutate(n_adj = n/effort*300) %>% # add column adjusted for effort
  ungroup()

```

## Summaries of abundance

### Raw abundance by species

```{r}

# Summary table of overall mammal abundances

summary <- smamms %>% 
  group_by(species, binomial, family) %>% 
  summarize(n = length(species)) %>% 
  ungroup() %>% 
  arrange(-n)

kable(summary[,2:4], col.names = c('Binomial', 'Family', 'Individuals')) %>% 
  kable_styling(bootstrap_options = c('striped', 'condensed'),
                full_width = FALSE,
                position = 'left') %>% 
  column_spec(1, italic = TRUE) %>% 
  column_spec(1, width = '5cm')

```

- Although traps were primarily open at night, we can still include diurnal species (chipmunks, squirrels) in measures of relative abundance because traps were opened and closed at approximately the same time each day.
- Flying squirrels spend a significant amount of time foraging on the ground, so their capture was not a fluke.

<br>

### Abundance by site

```{r}

# Jitterplot with mean/SE
ggplot(abundance, aes(x = severity, y = n_adj)) +
  geom_jitter(aes(color = severity)) +
  scale_color_manual(values = cols) +
  stat_summary(fun.data = mean_se, geom = "crossbar", width = .5) +
  theme_classic() +
  labs(x = 'Fire Severity',
       y = 'Total small mammal abundance') +
  theme(legend.position = 'NA') +
  scale_x_discrete(labels = xlabs)

```

```{r, eval=FALSE}

# Check summary stats and model assumptions for total abundance per site

# Summary table
abundance %>% 
  group_by(severity) %>% 
  get_summary_stats(n_adj)

# Check for outliers
abundance %>% group_by(severity) %>% 
  identify_outliers(n_adj)
# 2 outliers (HICORN and MIXMOR), no extreme outliers

# Check for normality
lm <- lm(n_adj~severity, data=abundance)
ggqqplot(residuals(lm))
ggqqplot(abundance, "n_adj", facet.by="severity")
shapiro_test(residuals(lm))
abundance %>% group_by(severity) %>% 
  shapiro_test(n_adj)
# The two outliers make the data not normal

# Homogoneity of variance
plot(lm,1)
abundance %>% levene_test(n_adj~severity)
# Variance is fine

#ANOVA
aov <- aov(n_adj~severity, data=abundance)
summary(aov)
abundance %>% ungroup() %>% 
  tukey_hsd(n_adj~severity)
eta_squared(aov)
cohens_f(aov)

#Kruskal-Wallis
kruskal_test(n_adj~severity, data=abundance)
kruskal_effsize(n_adj~severity, data=abundance)


```

Jitter plot points represent total small mammal abundance at each site; horizontal bars represent mean and standard error for each fire severity category. Abundance was standardized by trapping effort.

Two of these sites look like outliers:

- HICORN had a ridiculous number of PEMA
- MIXMOR had a lot of PEMA, OTBE, and SOTR

They make the data violate assumptions for ANOVA (data are not normal), so were removed for the following test.

```{r}

# Removing the two outliers
abundance2 <- abundance %>% 
  filter(site!='MIXMOR', site!='HICORN')

# Jitterplot with mean/SE
ggplot(abundance2, aes(x = severity, y = n_adj)) +
  geom_jitter(aes(color = severity)) +
  scale_color_manual(values = cols) +
  stat_summary(fun.data = mean_se, geom = "crossbar", width = .5) +
  theme_classic() +
  labs(x = 'Fire Severity',
       y = 'Total small mammal abundance') +
  theme(legend.position = 'NA') +
  scale_x_discrete(labels = xlabs)

# ANOVA
aov <- aov(n_adj~severity, data=abundance2)
summary(aov)
abundance2 %>% ungroup() %>% 
  tukey_hsd(n_adj~severity)
eta_squared(aov)
cohens_f(aov)

```

Jitter plot points represent total small mammal abundance at each site; horizontal bars represent mean and standard error for each fire severity category. Sites HICORN and MIXMOR were removed. Abundance was standardized by trapping effort.

- ANOVA F=5.78, p=0.0096
- Tukey mod vs. high p=0.00706

<br>

### Proportional abundance by site

```{r proportional abundance per site, fig.width=7}

# Dataframe of proportional species abundance per site
prop_site <- smamms %>% 
  group_by(site, severity, species, binomial) %>% 
  summarize(n = length(species)) %>% 
  group_by(site) %>% 
  mutate(prop = n/sum(n)*100) %>% 
  ungroup() %>% 
  arrange(severity) %>% 
  mutate(site = factor(site, levels = unique(site))) %>% # order sites by severity
  mutate(binomial = factor(binomial, levels = summary$binomial)) # order species by total abundance

# Column graph of proportional species abundance per site
ggplot(prop_site, aes(x = site, y = prop,
                                       fill = binomial)) +
  geom_col() +
  labs(x = 'Site',
       y = 'Occurence by species (%)') +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  scale_y_continuous(breaks = c(0, 50, 100),
                     expand = c(0, 0)) +
  scale_fill_manual(values=cal_palette(name = 'sierra2', n = 11, type = 'continuous')) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_grid(~ severity,
             scale = 'free',
             labeller = as_labeller(c('unb' = 'Unburned',
                                      'mod' = 'Moderate',
                                      'high' = 'High')))

```

<br>

### Proportional abundance by species

```{r proportional abundance per species}

# Data frame of proportional treatment abundances per species

prop_species <- smamms %>% 
  group_by(species, common_name, site, severity) %>% 
  summarize(n = length(site)) %>% 
  full_join(effort) %>% 
  mutate(cpue = n/effort * 300) %>% # adjust for trapping effort
  group_by(species, common_name, severity) %>% 
  summarize(n = sum(cpue)) %>% 
  mutate(prop = n/sum(n)*100) %>% # proportion of captures at each treatment, per species
  mutate(label = common_name) %>% 
  ungroup()

prop_low <- prop_species %>%  # data frame for just low severity
  filter(severity == 'unb') %>% 
  select(species, prop) %>% 
  rename(prop_low = prop)
prop_mod <- prop_species %>%  # data for just moderate severity
  filter(severity == 'mod') %>% 
  select(species, prop) %>% 
  rename(prop_mod = prop)

prop_species2 <- prop_species %>% # re-ordering data frame occurence within each severity
  full_join(prop_low) %>% 
  full_join(prop_mod) %>% 
  mutate(
    prop_low = case_when(
      is.na(prop_low) ~ 0,
      !is.na(prop_low) ~ prop_low
    ),
    prop_mod = case_when(
      is.na(prop_mod) ~ 0,
      !is.na(prop_mod) ~ prop_mod
    )
  ) %>% 
  ungroup() %>% 
  mutate(label = as_factor(label),
         label = fct_reorder(label, prop_mod),
         label = fct_reorder(label, prop_low),
         severity = factor(severity, levels = c('high', 'mod', 'unb'))) %>% 
  full_join(summary, by = 'species')

# Column graph of proportional treatment abundances per species

colors <- c('red', 'orange', 'darkgreen')

ggplot(prop_species2, aes(x = label, y = prop, fill = severity)) +
  geom_col() +
  geom_text(aes(x = label, y = 103,
                label = paste('n = ', n.y)),
            size = 3.2, hjust = 0, color = 'grey30') +
  scale_fill_manual(values = colors,
                    name = 'Fire severity',
                    labels = labs) +
  coord_flip() +
  scale_y_continuous(limits = c(0, 200),
                     breaks = c(0, 50, 100),
                     expand = c(0,0)) +
  theme_minimal() +
  labs(x = '', y = '') +
  theme(axis.text.y = element_text(size = 10, color = 'black'),
        axis.text.x = element_text(size = 10),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = 'none',
        axis.title.x = element_text(hjust = 3.8, size = 13))

ggsave('figs/fig5a.png', plot = last_plot(),
       width = 4, height = 3, units = 'in')

```

- Habitat preferences for the 11 species of mammals, standardized by trapping effort.

<br>

## Abundance by species

```{r abundance per species, include=TRUE, fig.width=3, fig.height=2}

# Plot total abundance for species at each site

for (i in unique(smamms$species)) {
  
  data <- smamms %>% 
  filter(species == i) %>% 
  group_by(site, severity) %>% 
  tally() %>%
  full_join(abundance, by = c('site', 'severity')) %>% 
  mutate(non_target = (n.y-n.x),
         effort_target = effort - non_target/2,
         n_target = n.x,
         n_adj_target = case_when(
           !is.na(n_target) ~ (n_target/effort_target)*300,
           TRUE ~ 0
           )) %>% 
  select(site, severity, n_target, effort_target, n_adj_target) 
  
  plot <- ggplot(data, aes(x = severity, y = n_adj_target)) +
    geom_jitter(aes(color = severity), height=0) +
    scale_color_manual(values = cols) +
    stat_summary(fun.data = mean_se, geom = "crossbar", width=0.5) +
    theme_classic() +
    labs(x = 'Fire Severity',
         y = 'Abundance',
         title = i) +
    theme(legend.position = 'NA') +
    scale_x_discrete(labels = xlabs)
  
  print(plot)
  
}

```

Jitter plot points represent total small mammal abundance at each site; horizontal bars represent mean and standard error for each fire severity category. Abundance was standardized by trapping effort for each species individually (i.e. non-target species were counted as half of a trap night, similar to treatment of sprung traps)

<br>

### Deer mouse (PEMA)
  
```{r}

# PEMA abundance
pema <- smamms %>% 
  filter(species == 'PEMA') %>% 
  group_by(site, severity) %>% 
  tally() %>%
  full_join(abundance, by = c('site', 'severity')) %>% 
  mutate(non_target = (n.y-n.x),
         effort_pema = effort - non_target/2,
         n_pema = n.x,
         n_adj_pema = case_when(
           !is.na(n_pema) ~ (n_pema/effort_pema)*300,
           TRUE ~ 0
           )) %>% 
  select(site, severity, n_adj_pema) %>% 
  ungroup()

# Check summary stats and model assumptions for total PEMA abundance per site

# Summary table
pema %>% 
  group_by(severity) %>% 
  get_summary_stats(n_adj_pema)

# Check for outliers
pema %>% group_by(severity) %>% 
  identify_outliers(n_adj_pema)
# 1 outlier in HICORN, no extreme outliers

# Check for normality
lm <- lm(n_adj_pema~severity, data=pema)
ggqqplot(residuals(lm))
ggqqplot(pema, "n_adj_pema", facet.by="severity")
shapiro_test(residuals(lm))
pema %>% 
  group_by(severity) %>% 
  shapiro_test(n_adj_pema)
# The outlier makes the data not normal

# Homogoneity of variance
plot(lm,1)
pema %>% ungroup() %>%
  levene_test(n_adj_pema~severity)
# Variance is fine

kruskal_test(n_adj_pema~severity, data=pema)
kruskal_effsize(n_adj_pema~severity, data=pema)

### REMOVE HICORN FOR STATS

# Removing the outlier
pema2 <- pema %>% 
  filter(site!='HICORN')

# Jitterplot with mean/SE
ggplot(pema2, aes(x = severity, y = n_adj_pema)) +
  geom_jitter(aes(color = severity)) +
  scale_color_manual(values = cols) +
  stat_summary(fun.data = mean_se, geom = "crossbar", width = .5) +
  theme_classic() +
  labs(x = 'Fire Severity',
       y = 'PEMA Abundance') +
  theme(legend.position = 'NA') +
  scale_x_discrete(labels = xlabs)

# ANOVA
summary(aov(n_adj_pema~severity, data=pema2))
pema2 %>% ungroup() %>% 
  tukey_hsd(n_adj_pema~severity)

```

Jitter plot points represent PEMA abundance at each site; horizontal bars represent mean and standard error for each fire severity category. Site HICORN was removed. Abundance was standardized by trapping effort.

- ANOVA F=5.619, p=0.0103
- Tukey unb vs. high p=0.0158, mod vs. high p=0.0253

<br>

### Trowbridge's shrew (SOTR)

```{r}

# SOTR abundance
sotr <- smamms %>% 
  filter(species == 'SOTR') %>% 
  group_by(site, severity) %>% 
  tally() %>%
  full_join(abundance, by = c('site', 'severity')) %>% 
  mutate(non_target = (n.y-n.x),
         effort_sotr = effort - non_target/2,
         n_sotr = n.x,
         n_adj_sotr = case_when(
           !is.na(n_sotr) ~ (n_sotr/effort_sotr)*300,
           TRUE ~ 0
           )) %>% 
  select(site, severity, n_adj_sotr)

# Check summary stats and model assumptions for total PEMA abundance per site

# Summary table
sotr %>% 
  group_by(severity) %>% 
  get_summary_stats(n_adj_sotr)

# Check for outliers
sotr %>% group_by(severity) %>% 
  identify_outliers(n_adj_sotr)
# 2 outliers: MIXDP2 and MIXMOR, both extreme

# Check for normality
lm <- lm(n_adj_sotr~severity, data=sotr)
ggqqplot(residuals(lm))
ggqqplot(sotr, "n_adj_sotr", facet.by="severity")
shapiro_test(residuals(lm))
# The outlier makes the data not normal

# Homogoneity of variance
plot(lm,1)
sotr %>% ungroup() %>%
  levene_test(n_adj_sotr~severity)
# Variance is all weird because high sites had no shrews






### REMOVE HICORN FOR STATS

# Removing the outlier
sotr2 <- sotr %>% 
  filter(site!='HICORN')

# Jitterplot with mean/SE
ggplot(sotr, aes(x = severity, y = n_adj_sotr)) +
  geom_jitter(aes(color = severity)) +
  scale_color_manual(values = cols) +
  stat_summary(fun.data = mean_se, geom = "crossbar", width = .5) +
  theme_classic() +
  labs(x = 'Fire Severity',
       y = 'SOTR Abundance') +
  theme(legend.position = 'NA') +
  scale_x_discrete(labels = xlabs)

# ANOVA
summary(aov(n_adj_sotr~severity, data=sotr))
sotr %>% ungroup() %>% 
  tukey_hsd(n_adj_sotr~severity)

sotr %>% ungroup() %>% 
  welch_anova_test(n_adj_sotr~severity)


```

<br>

## Population size by Schnabel's estimate

```{r Schnabel estimate}

# Calculating Schnabel's estimate of population size for each site

# Data wrangling

caps <- captures %>% 
  dplyr::select(site, day, indID, recap) %>% 
  filter(!is.na(indID))

# Function that outputs a data frame with the vectors needed to calculate the Schnabel estimate
# Input is the site code

vectorify <- function(site_code) {
  caps %>% 
  filter(site == site_code) %>% 
  group_by(day, recap) %>% 
  summarize(n = length(indID)) %>% 
  spread(key = recap, value = n, fill = 0) %>% 
  mutate(catch = Y + N) %>% 
  rename(recaps = Y,
         newmarks = N)
}

# Calculate Schnabel's estimate for each site and create data frame of results

pop_est <- data.frame(site = factor(),
                      pop = numeric())

for (i in unique(smamms$site)) {
  schnabel_vecs <- vectorify(i)
  schnabel <- schnabel(catch = schnabel_vecs$catch,
              recaps = schnabel_vecs$recaps,
              newmarks = schnabel_vecs$newmarks)
  pop_est <- rbind(pop_est, data.frame(i, schnabel$N[1]))
}

# Combine abundance and Schnabel data frames

cap_rate <- full_join(pop_est, abundance, by = c('i' = 'site')) %>% 
  rename(site = i,
         schnabel = 'schnabel.N.1.') %>% 
  mutate(cap_rate = n/schnabel)

```

**Population size, as calculated from the Schnabel estimate:** 

```{r Schnabel estimate boxplot}

ggplot(cap_rate, aes(x = severity, y = schnabel)) +
  geom_jitter(aes(color = severity)) +
  scale_color_manual(values = cols) +
  stat_summary(fun.data = mean_se, geom = "crossbar", width = .5) +
  theme_classic() +
  labs(x = 'Fire Severity',
       y = 'Population Size (n)') +
  theme(legend.position = 'NA') +
  scale_x_discrete(labels = xlabs)

```

<br>

**Capture rate at the three treatments:**

```{r capture rate boxplot, echo=FALSE}

ggplot(cap_rate, aes(x = severity, y = cap_rate)) +
  geom_jitter(aes(color = severity)) +
  scale_color_manual(values = cols) +
  stat_summary(fun.data = mean_se, geom = "crossbar", width = .5) +
  theme_classic() +
  labs(x = 'Fire Severity',
       y = 'Population Size (n)') +
  theme(legend.position = 'NA') +
  scale_x_discrete(labels = xlabs)

```

- Capture rate calculated as the number of unique individuals captured divided by the Schnabel estimate of population size.
- All but three sites had a capture rate >75%.


```{r eval=FALSE}

# Export abundance data

abundance_dat <- full_join(abundance, pema) %>% 
  full_join(sotr)

write_csv(abundance_dat, 'output_data/abundance.csv', col_names = TRUE)

```

```{r eval=FALSE}
rmarkdown::render('code/03_abundance.Rmd', output_file = '../docs/03_abundance.html')
```

