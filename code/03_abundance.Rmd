---
title: "Abundance Analyses"
author: "Kate Culhane"
date: "November 9, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = '..')
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width=5, fig.height=3)
```

<br>

### Cumulative Abundance

```{r packages and data}

# Load necessary packages

library(tidyverse)
library(dunn.test)
library(kableExtra)
library(RColorBrewer)
library(fishmethods) # for Schnabel's estimate

# Load necessary data

smamms <- read_csv('output_data/unique_smamms.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

captures <- read_csv('output_data/smamms.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

effort <- read_csv('output_data/effort.csv') %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

```

```{r total abundance data frame}

# Calculate total abundance summed across all species at each site (raw and adjusted)

abundance <- smamms %>% 
  group_by(site, severity) %>% 
  tally() %>% # count individuals per site
  full_join(effort) %>% 
  mutate(n_adj = n/effort*300) # add column adjusted for effort

```

**Total raw abundance per species, summed across all sites:**

```{r abundance per species summary table}

# Summary table of overall mammal abundances

summary <- smamms %>% 
  group_by(species, binomial, family) %>% 
  summarize(n = length(species)) %>% 
  ungroup() %>% 
  arrange(-n)

cols <- c('Binomial', 'Family', 'Individuals')

kable(summary[,2:4], col.names = cols) %>% 
  kable_styling(bootstrap_options = c('striped', 'condensed'),
                full_width = FALSE,
                position = 'left') %>% 
  column_spec(1, italic = TRUE) %>% 
  column_spec(1, width = '5cm')

```

- Although traps were primarily open at night, we can still include diurnal species (chipmunks, squirrels) in measures of relative abundance because traps were opened and closed at approximately the same time each day.
- Flying squirrels spend a significant amount of time foraging on the ground, so their capture was not a fluke.

<br>

**Overall abundance of small mammals was consistent across fire severities:** 

```{r abundance across severities boxplot}

# Summary table

abundance_summary <- abundance %>% 
  group_by(severity) %>% 
  summarize(mean = mean(n),
            sd = sd(n))

# Summarize data with boxplots

colors <- c('darkgreen', 'orange', 'red')
xlabs <- c('Unburned', 'Moderate Severity', 'High Severity') 

ggplot(abundance, aes(x = severity, y = n_adj)) +
  geom_boxplot(aes(fill = severity)) +
  scale_fill_manual(values = colors) +
  theme_minimal() +
  labs(x = 'Fire Severity',
       y = 'Total small mammal abundance') +
  theme(legend.position = 'NA') +
  scale_x_discrete(labels = xlabs)

```

```{r abundance across severities kruskal-wallis, eval=FALSE}

# Calculate mean abundance for each treatment

abundance %>% 
  group_by(severity) %>% 
  summarize(
    n_mean = mean(n_adj),
    n_sd = sd(n_adj)
  )

# Does the total abundance (summed across species) vary across the fire severity gradient?

# Explore the data distribution and variance

ggplot(abundance, aes(x = n_adj)) +
  geom_histogram(bins = 6) +
  facet_wrap(~severity)

ggplot(abundance, aes(sample = n_adj)) +
  geom_qq() +
  facet_wrap(~severity)

abundance %>% 
  group_by(severity) %>% 
  summarize(variance = var(n_adj))

# Histograms look a little funky because sample size is so small, qq-plots look normal
# n=9 for each severity, so cannot use CLT to justify normality
# Variances are WAY different (>4x)


# Kruskal Wallis

kruskal.test(n_adj ~ severity, data = abundance)
# p>0.05, so there are no sig differences in means

```

- The abundance of small mammals summed across all species and standardized by trapping effort did not differ significantly between fire severity treatments (Kruskal-Wallis $\chi^2$(2) = 5.3, p = 0.07, n = 9 for each).
- However, it qualitatively looks like abundance is much higher in high sevrity sites

<br>

### Proportional Abundance

**Small mammal community composition varied across fire severities:** 

```{r proportional abundance per site, fig.width=7}

# Dataframe of proportional species abundance per site

prop_site <- smamms %>% 
  group_by(site, severity, species, binomial) %>% 
  summarize(n = length(species)) %>% 
  group_by(site) %>% 
  mutate(prop = n/sum(n)*100) %>% 
  ungroup() %>% 
  arrange(severity) %>% 
  mutate(site = factor(site, levels = unique(site))) %>% # order sites by severity
  mutate(binomial = factor(binomial, levels = summary$binomial)) # order species by total abundance

# Column graph of proportional species abundance per site

ggplot(prop_site, aes(x = site, y = prop,
                                       fill = binomial)) +
  geom_col() +
  labs(x = 'Site',
       y = 'Occurence by species (%)') +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  scale_y_continuous(breaks = c(0, 50, 100),
                     expand = c(0, 0)) +
  scale_fill_brewer(type = 'qual', palette = 3,
                    name = 'Species') +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_grid(~ severity,
             scale = 'free',
             labeller = as_labeller(c('unb' = 'Unburned',
                                      'mod' = 'Moderate',
                                      'high' = 'High')))

```

- The proportion of abundance by species is shown for each site across the fire severity gradient.

<br>

**Small mammal community varied across fire severities:** 

```{r proportional abundance per species}

# Data frame of proportional treatment abundances per species

prop_species <- smamms %>% 
  group_by(species, binomial_short, site, severity) %>% 
  summarize(n = length(site)) %>% 
  full_join(effort) %>% 
  mutate(cpue = n/effort * 300) %>% # adjust for trapping effort
  group_by(species, binomial_short, severity) %>% 
  summarize(n = sum(cpue)) %>% 
  mutate(prop = n/sum(n)*100) %>% # proportion of captures at each treatment, per species
  mutate(label = binomial_short) %>% 
  ungroup()

prop_low <- prop_species %>%  # data frame for just low severity
  filter(severity == 'unb') %>% 
  select(species, prop) %>% 
  rename(prop_low = prop)
prop_mod <- prop_species %>%  # data for just moderate severity
  filter(severity == 'mod') %>% 
  select(species, prop) %>% 
  rename(prop_mod = prop)

prop_species2 <- prop_species %>% # re-ordering data frame occurence within each severity
  full_join(prop_low) %>% 
  full_join(prop_mod) %>% 
  mutate(
    prop_low = case_when(
      is.na(prop_low) ~ 0,
      !is.na(prop_low) ~ prop_low
    ),
    prop_mod = case_when(
      is.na(prop_mod) ~ 0,
      !is.na(prop_mod) ~ prop_mod
    )
  ) %>% 
  ungroup() %>% 
  mutate(label = as_factor(label),
         label = fct_reorder(label, prop_mod),
         label = fct_reorder(label, prop_low),
         severity = factor(severity, levels = c('high', 'mod', 'unb'))) %>% 
  full_join(summary, by = 'species')

# Column graph of proportional treatment abundances per species

colors <- c('red', 'orange', 'darkgreen')

ggplot(prop_species2, aes(x = label, y = prop, fill = severity)) +
  geom_col() +
  geom_text(aes(x = label, y = 103,
                label = paste('n = ', n.y)),
            size = 4, hjust = 0, color = 'grey30') +
  scale_fill_manual(values = colors,
                    name = 'Fire severity',
                    labels = labs) +
  coord_flip() +
  scale_y_continuous(limits = c(0, 200),
                     breaks = c(0, 50, 100),
                     expand = c(0,0)) +
  theme_minimal() +
  labs(x = '', y = '') +
  theme(axis.text.y = element_text(face = 'italic', size = 12, color = 'black'),
        axis.text.x = element_text(size = 12),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = 'none',
        axis.title.x = element_text(hjust = 3.8, size = 13))

ggsave('figs/fig5a.png', plot = last_plot(),
       width = 4, height = 3, units = 'in')

```

- Habitat preferences for the 11 species of mammals, standardized by trapping effort.

<br>

### Abundance of each species separately

```{r abundance per species, include=TRUE, fig.width=3, fig.height=2}

# Plot total abundance for species at each site

xlabs <- c('Unburned', 'Moderate', 'High') 

for (i in unique(smamms$species)) {
  
  data <- smamms %>% 
  filter(species == i) %>% 
  group_by(site, severity) %>% 
  tally() %>%
  full_join(abundance, by = c('site', 'severity')) %>% 
  mutate(non_target = (n.y-n.x),
         effort_target = effort - non_target/2,
         n_target = n.x,
         n_adj_target = case_when(
           !is.na(n_target) ~ (n_target/effort_target)*300,
           TRUE ~ 0
           )) %>% 
  select(site, severity, n_target, effort_target, n_adj_target) 
  
  plot <- ggplot(data, aes(x = severity, y = n_adj_target)) +
    geom_boxplot(aes(fill = severity)) +
    scale_fill_manual(values = colors) +
    theme_minimal() +
    labs(x = 'Fire Severity',
         y = 'Abundance',
         title = i) +
    theme(legend.position = 'NA') +
    scale_x_discrete(labels = xlabs)
  
  print(plot)
  
}

```

```{r, eval=FALSE}

# Stats for total abundance for species at each site

for (i in unique(smamms$species)) {
  
  data <- smamms %>% 
  filter(species == i) %>% 
  group_by(site, severity) %>% 
  tally() %>%
  full_join(abundance, by = c('site', 'severity')) %>% 
  mutate(non_target = (n.y-n.x),
         effort_target = effort - non_target/2,
         n_target = n.x,
         n_adj_target = case_when(
           !is.na(n_target) ~ (n_target/effort_target)*300,
           TRUE ~ 0
           )) %>% 
  select(site, severity, n_target, effort_target, n_adj_target) 
  
  print(i)
  kruskal.test(n_adj_target ~ severity, data = data)
  dunn.test(data$n_adj_target, data$severity,
            method = 'bonferroni')
  
}

```

**Significant results:**

- PEMA (KW p = 0.009835)
  - mod-high (Dunns p = 0.0167)
  - unb-high (Dunns p = 0.0099)
- SOTR (KW p = 0.00009407)
  - unb-mod (Dunns p = 0.0019)
  - unb-high (Dunns p = 0.0001)
  
```{r}

# PEMA abundance

pema <- smamms %>% 
  filter(species == 'PEMA') %>% 
  group_by(site, severity) %>% 
  tally() %>%
  full_join(abundance, by = c('site', 'severity')) %>% 
  mutate(non_target = (n.y-n.x),
         effort_pema = effort - non_target/2,
         n_pema = n.x,
         n_adj_pema = case_when(
           !is.na(n_pema) ~ (n_pema/effort_pema)*300,
           TRUE ~ 0
           )) %>% 
  select(site, n_adj_pema)

# SOTR abundance

sotr <- smamms %>% 
  filter(species == 'SOTR') %>% 
  group_by(site, severity) %>% 
  tally() %>%
  full_join(abundance, by = c('site', 'severity')) %>% 
  mutate(non_target = (n.y-n.x),
         effort_sotr = effort - non_target/2,
         n_sotr = n.x,
         n_adj_sotr = case_when(
           !is.na(n_sotr) ~ (n_sotr/effort_sotr)*300,
           TRUE ~ 0
           )) %>% 
  select(site, n_adj_sotr)

# Export abundance data

abundance_dat <- full_join(abundance, pema) %>% 
  full_join(sotr)

write_csv(abundance_dat, 'output_data/abundance.csv', col_names = TRUE)

```

<br>

### Population size by Schnabel's estimate

```{r Schnabel estimate}

# Calculating Schnabel's estimate of population size for each site

# Data wrangling

caps <- captures %>% 
  dplyr::select(site, day, indID, recap) %>% 
  filter(!is.na(indID))

# Function that outputs a data frame with the vectors needed to calculate the Schnabel estimate
# Input is the site code

vectorify <- function(site_code) {
  caps %>% 
  filter(site == site_code) %>% 
  group_by(day, recap) %>% 
  summarize(n = length(indID)) %>% 
  spread(key = recap, value = n, fill = 0) %>% 
  mutate(catch = Y + N) %>% 
  rename(recaps = Y,
         newmarks = N)
}

# Calculate Schnabel's estimate for each site and create data frame of results

pop_est <- data.frame(site = factor(),
                      pop = numeric())

for (i in unique(smamms$site)) {
  schnabel_vecs <- vectorify(i)
  schnabel <- schnabel(catch = schnabel_vecs$catch,
              recaps = schnabel_vecs$recaps,
              newmarks = schnabel_vecs$newmarks)
  pop_est <- rbind(pop_est, data.frame(i, schnabel$N[1]))
}

# Combine abundance and Schnabel data frames

cap_rate <- full_join(pop_est, abundance, by = c('i' = 'site')) %>% 
  rename(site = i,
         schnabel = 'schnabel.N.1.') %>% 
  mutate(cap_rate = n/schnabel)

```

**Population size, as calculated from the Schnabel estimate:** 

```{r Schnabel estimate boxplot}

# Boxplot of Schnabel estimate of population size by severity

ggplot(cap_rate, aes(x = severity, y = schnabel)) +
  geom_boxplot(aes(fill = severity)) +
  scale_fill_manual(values = colors) +
  theme_minimal() +
  labs(x = 'Fire Severity',
       y = 'Population Size (N)') +
  theme(legend.position = 'NA') +
  scale_x_discrete(labels = xlabs)

```

<br>

**Capture rate at the three treatments:**


```{r capture rate boxplot, echo=FALSE}

# Boxplot of capture rate by severity

ggplot(cap_rate, aes(x = severity, y = cap_rate)) +
  geom_boxplot(aes(fill = severity)) +
  scale_fill_manual(values = colors) +
  theme_minimal() +
  labs(x = 'Fire Severity',
       y = 'Capture Rate (%)') +
  theme(legend.position = 'NA') +
  scale_x_discrete(labels = xlabs)

```

- Capture rate calculated as the number of unique individuals captured divided by the Schnabel estimate of population size.
- All but three sites had a capture rate >75%.

```{r eval=FALSE}

rmarkdown::render('code/03_abundance.Rmd', output_file = '../docs/03_abundance.html')

```

