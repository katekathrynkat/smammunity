---
title: "Abundance (cumulative and *P. maniculatus*)"
author: "Kate"
date: "November 9, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=5, fig.height=3, fig.align='center')
```


```{r packages and data, include=FALSE}

# Load necessary packages

library(tidyverse)
library(dunn.test)
library(kableExtra)
library(RColorBrewer)

# Load necessary data

smamms <- read_csv('./data/unique_smamms.csv') # using dataset with one row per unique individual
effort <- read_csv('./data/effort.csv')

```


```{r data wrangling, include=FALSE}

# Update classes

smamms <- smamms %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

# Data frame containing only sites and severities

sevs <- smamms %>% 
  group_by(site) %>% 
  filter(row_number()==1) %>% 
  select(site, severity)

# Data frame containing only species information

species <- smamms %>% 
  group_by(species) %>% 
  filter(row_number()==1) %>% 
  select(species, family, binomial, binomial_short)

```


###Total abundance


```{r total abundance data frame, include=FALSE}

# Calculate total abundance summed across all species at each site

abundance <- smamms %>% 
  group_by(site) %>% 
  tally() %>% # count individuals per site
  full_join(., smamms, by = 'site') %>% 
  select(site, severity, n) %>% 
  group_by(site) %>% 
  filter(row_number()==1) %>%
  ungroup() %>% 
  full_join(., effort, by = 'site') %>% 
  mutate(n_adj = n/effort*300) # add column adjusted for effort

```

```{r summary stats, eval=FALSE, include=FALSE}

# Summary stats

dim(smamms) # 545 unique individuals

length(unique(smamms$species)) # 11 species

```


**Total raw abundance per species, summed across all sites.**

- Although traps were primarily open at night, we can still include diurnal species (chipmunks, squirrels) in measures of relative abundance because traps were opened and closed at approximately the same time each day.
- Flying squirrels spend a significant amount of time foraging on the ground, so their capture was not a fluke.

```{r abundance per species summary table, echo=FALSE}

# Summary table of overall mammal abundances

summary <- smamms %>% 
  group_by(species) %>% 
  summarize(n = length(species)) %>% 
  full_join(., species, by = 'species') %>% 
  select(family, binomial, n) %>% 
  arrange(-n)

cols = c('Family', 'Binomial', 'Individuals')

summary_table <- kable(summary,
                       col.names = cols) %>% 
  kable_styling(bootstrap_options = c('striped', 'condensed'),
                full_width = FALSE) %>% 
  column_spec(2, italic = TRUE) %>% 
  column_spec(1, width = '3cm')

summary_table

```


```{r abundance across severities kruskal-wallis, eval=FALSE, include=FALSE}

# Does the total abundance (summed across species) vary across the fire severity gradient?

# Explore the data distribution

# Make histograms for each treatment

n_hist <- ggplot(abundance, aes(x = n_adj)) +
  geom_histogram() +
  facet_wrap(~severity)

n_hist

# Make qqplots for each treatment

n_qq <- ggplot(abundance, aes(sample = n_adj)) +
  geom_qq() +
  facet_wrap(~severity)

n_qq

# Histograms look a little funky because sample size is so small
# qq-plots look normal
# n=9 for each severity, so cannot use CLT to justify normality



# Explore variance

variances <- abundance %>% 
  group_by(severity) %>% 
  summarize(
    variance = var(n_adj)
  )

variances

# Variances are WAY different (>4x)
# Cannot satisfy assumptions of ANOVA
# Test for significant differences in means



# Kruskal Wallis

n_kw <- kruskal.test(n_adj ~ severity, data = abundance)

n_kw

# p>0.05, so there are no sig differences in means

```

**Overall abundance of small mammals was consistent across fire severities.** The abundance of small mammals summed across all species and standardized by trapping effort did not differ significantly between fire severity treatments (Kruskal-Wallis $\chi^2$(2) = 5.3, p = 0.07, n = 9 for each).

```{r abundance across severities boxplot, echo=FALSE}

# Summarize data with boxplots

colors <- c('darkgreen', 'orange', 'red')
xlabs <- c('Unburned', 'Moderate Severity', 'High Severity') 

n_boxplot <- ggplot(abundance, aes(x = severity, y = n_adj)) +
  geom_boxplot(aes(fill = severity)) +
  scale_fill_manual(values = colors) +
  theme_minimal() +
  labs(x = 'Fire Severity',
       y = 'Total small mammal abundance') +
  theme(legend.position = 'NA') +
  scale_x_discrete(labels = xlabs)

n_boxplot 

# Calculate mean diversity for each treatment

n_summary <- abundance %>% 
  group_by(severity) %>% 
  summarise(
    n_mean = mean(n_adj),
    n_sd = sd(n_adj)
  )

```


###Proportional abundance

**Small mammal community composition varied across fire severities.** The proportion of abundance by species is shown for each site across the fire severity gradient.

```{r proportional abundance per site, fig.width=7, echo=FALSE}

# Dataframe of proportional species abundance per site

prop_site <- smamms %>% 
  group_by(site, species) %>% 
  summarize(n = length(species)) %>% 
  mutate(prop = n/sum(n)*100) %>% 
  full_join(sevs, by = 'site') %>% 
  full_join(species, by = 'species') %>% 
  ungroup() %>% 
  arrange(severity) %>% 
  mutate(site = factor(site, levels = unique(site))) %>% # order sites by severity
  mutate(binomial = factor(binomial, levels = summary$binomial)) # order species by total abundance

# Column graph of proportional species abundance per site

prop_site_fig <- ggplot(prop_site, aes(x = site, y = prop,
                                       fill = binomial)) +
  geom_col() +
  labs(x = 'Site',
       y = 'Occurence by species (%)') +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  scale_x_discrete(labels = c('1', '2', '3', '4', '5', '6', '7', '8', '9')) +
  scale_y_continuous(breaks = c(0, 50, 100),
                     expand = c(0, 0)) +
  scale_fill_brewer(type = 'qual', palette = 3,
                    name = 'Species') +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  facet_grid(~ severity,
             scale = 'free',
             labeller = as_labeller(c('unb' = 'Unburned',
                                      'mod' = 'Moderate',
                                      'high' = 'High')))

prop_site_fig

```


**Small mammal community varied across fire severities.** Habitat preferences for the 11 species of mammals, standardized by trapping effort.

- Paired figure with NMDS plot

```{r proportional abundance per species, echo=FALSE}

# Data frame of proportional treatment abundances per species

prop_species <- smamms %>% 
  group_by(species, site) %>% 
  summarize(n = length(site)) %>% 
  full_join(effort, by = 'site') %>% 
  mutate(cpue = n/effort * 300) %>% # adjust for trapping effort
  full_join(sevs, by = 'site') %>% 
  group_by(species, severity) %>% 
  summarize(n = sum(cpue)) %>% 
  mutate(prop = n/sum(n)*100) %>% # proportion of captures at each treatment, per species
  left_join(species, by = 'species')

prop_high <- prop_species %>%  # data frame for just high severity
  filter(severity == 'high') %>% 
  select(species, prop) %>% 
  rename(prop_high = prop)
prop_mod <- prop_species %>%  # data for just moderate severity
  filter(severity == 'mod') %>% 
  select(species, prop) %>% 
  rename(prop_mod = prop)

prop_species2 <- prop_species %>% 
  full_join(prop_high, by = 'species') %>% 
  full_join(prop_mod, by = 'species') %>% 
  mutate(
    prop_high = case_when(
      is.na(prop_high) ~ 0,
      !is.na(prop_high) ~ prop_high
    ),
    prop_mod = case_when(
      is.na(prop_mod) ~ 0,
      !is.na(prop_mod) ~ prop_mod
    )
  ) %>% 
  ungroup() %>% 
  mutate(binomial_short = as_factor(binomial_short),
         binomial_short = fct_reorder(binomial_short, prop_mod),
         binomial_short = fct_reorder(binomial_short, prop_high)) %>% 
  full_join(., summary, by = 'binomial')

# Column graph of proportional treatment abundances per species

colors <- c('darkgreen', 'orange', 'red')
labs <- c('Unburned', 'Moderate', 'High')

prop_species_fig <- ggplot(prop_species2,
                           aes(x = binomial_short,
                               y = prop,
                               fill = severity)) +
  geom_col() +
  geom_text(aes(x = binomial_short, y = 103,
                label = paste('n = ', n.y)),
            size = 3, hjust = 0) +
  scale_fill_manual(values = colors,
                    name = 'Fire severity',
                    labels = labs) +
  coord_flip() +
  scale_y_continuous(limits = c(0, 125),
                     breaks = c(0, 50, 100),
                     expand = c(0,0)) +
  theme_minimal() +
  labs(x = '',
       y = 'Occurence by fire severity (%)') +
  theme(axis.text.y = element_text(face = 'italic'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

prop_species_fig

```


###*P. maniculatus* abundance


```{r total PEMA abundance data frame, include=FALSE}

# Calculate total abundance for PEMA at each site

abundance_pema <- smamms %>% 
  filter(species == 'PEMA') %>% 
  group_by(site) %>% 
  tally() %>% # count individuals per site
  full_join(., smamms, by = 'site') %>% 
  select(site, severity, n) %>% 
  group_by(site) %>% 
  filter(row_number()==1) %>%
  ungroup() %>% 
  full_join(., abundance, by = c('site', 'severity')) %>% 
  mutate(non_pema = (n.y-n.x),
         effort_pema = effort - non_pema/2,
         n_pema = n.x,
         n_adj_pema = (n_pema/effort_pema)*300) %>% 
  select(site, severity, n_pema, effort_pema, n_adj_pema)

```


```{r PEMA abundance across severities kruskal-wallis, eval=FALSE, include=FALSE}

# Does the abundance of PEMA vary across the fire severity gradient?

# Explore the data distribution

# Make histograms for each treatment
n_pema_hist <- ggplot(abundance_pema, aes(x = n_adj_pema)) +
  geom_histogram() +
  facet_wrap(~severity)

n_pema_hist

# Make qqplots for each treatment
n_pema_qq <- ggplot(abundance_pema, aes(sample = n_adj_pema)) +
  geom_qq() +
  facet_wrap(~severity)

n_pema_qq

# Histograms look a little funky because sample size is so small
# qq-plots look normal except high severity has a crazy outlier
# n=9 for each severity, so cannot use CLT to justify normality



# Explore variance
variances <- abundance_pema %>% 
  group_by(severity) %>% 
  summarize(
    variance = var(n_adj_pema)
  )

variances

# Variances are WAY different (>4x)
# Cannot satisfy assumptions of ANOVA



# Test for significant differences in means

# Kruskal Wallis
n_pema_kw <- kruskal.test(n_adj_pema ~ severity, data = abundance_pema)

n_pema_kw

# p<0.05, so there is at least one sig difference in means

# Post-hoc pairwise testing

# Dunn's test
dunn.test(abundance_pema$n_adj_pema, abundance_pema$severity,
          method = 'bonferroni') # Bonferroni correction

# High severity is sig different from both unburned and mixed severity
# Unburned and mixed severity are not different from each other

```

***P. maniculatus* abundance increased in high severity sites.**  Abundance, standardized by trapping effort, differed significantly between the three fire severity treatments (Kruskal-Wallis $\chi^2$(2) = 9.2, p < 0.01, n = 9 for each). Post-hoc analysis by Dunn’s test with a Bonferroni correction showed that mean density in high severity sites (mean = 25.2 indv) differed significantly from both unburned (11.8 indv) and mixed severity sites (12.4 indv) (pairwise p = 0.01 and 0.02, respectively).

```{r PEMA abundance across severities boxplot, echo=FALSE}

# Summarize data with boxplots
colors <- c('darkgreen', 'orange', 'red')
xlabs <- c('Unburned', 'Moderate Severity', 'High Severity') 

n_pema_boxplot <- ggplot(abundance_pema, aes(x = severity, y = n_adj_pema)) +
  geom_boxplot(aes(fill = severity)) +
  scale_fill_manual(values = colors) +
  theme_minimal() +
  labs(x = 'Fire Severity',
       y = 'Abundance (number of individuals)') +
  theme(legend.position = 'NA') +
  scale_x_discrete(labels = xlabs)

n_pema_boxplot

# Calculate mean diversity for each treatment

n_pema_summary <- abundance_pema %>% 
  group_by(severity) %>% 
  summarise(
    n_pema_mean = mean(n_adj_pema),
    n_pema_sd = sd(n_adj_pema)
  )

```

