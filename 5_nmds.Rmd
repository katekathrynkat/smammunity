---
title: "NMDS"
author: "Kate"
date: "December 23, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align='center')
```


```{r packages and data, include=FALSE}

# Load necessary packages

library(tidyverse)
library(vegan)
library(goeveg)
library(pairwiseAdonis)

# Update functions

select <- dplyr::select

# Load necessary data

smamms <- read_csv('./data/unique_smamms.csv') # using dataset with one row per unique individual
effort <- read_csv('./data/effort.csv')

veg <- read_csv('./data/veg.csv') # csv created from vegetation variables calculated in '3_vegetation.Rmd'

spatial <- read_csv('./data/spatial.csv') # csv created from fire severity spatial variables calculated in '4_spatial.Rmd'

```


```{r data wrangling, include=FALSE}

# Update classes

smamms <- smamms %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

# Data frame containing only sites and severities

sevs <- smamms %>% 
  group_by(site) %>% 
  filter(row_number()==1) %>% 
  select(site, severity) %>% 
  arrange(severity)

# Combine habitat variables into new data frame

habitat <- full_join(veg, spatial)

```


```{r species matrices, include=FALSE}

# Create a species matrix

matrix_temp <- smamms %>% 
  mutate(site = factor(site, levels = sevs$site)) %>% # order sites by severity
  group_by(site, species) %>% 
  tally() %>% # count individuals per species per site
  spread(species, n) %>% # re-format into matrix
  ungroup() %>% 
  replace(., is.na(.), 0) # replace NAs with 0

sites <- matrix_temp$site # vector of just sites

matrix <- matrix_temp %>% 
  select(-site) # remove site column for input into vegan

matrix <- as.matrix(matrix)
rownames(matrix) <- sites



# Create a species matrix adjusted for trapping effort

matrix_temp <- smamms %>% 
  group_by(site, species) %>% 
  tally() %>% # count individuals per species per site
  full_join(., effort, by = 'site') %>% 
  mutate(n_adj = n/effort*300) %>% # add column for n adjusted for effort
  ungroup() %>% 
  mutate(site = factor(site, levels = sevs$site)) %>% # order sites by severity  
  select(site, species, n_adj) %>% 
  spread(species, n_adj) %>% # re-format into matrix
  replace(., is.na(.), 0) # replace NAs with 0

sites <- matrix_temp$site # vector of just sites

matrix_adj <- matrix_temp %>% 
  select(-site) # remove site column for input into vegan

matrix_adj <- as.matrix(matrix_adj)
rownames(matrix_adj) <- sites

```


```{r distance metric, eval=FALSE, include=FALSE}

# Choose a distance metric

rank <- rankindex(habitat$severity,
                  wisconsin(matrix_adj),
                  indicies = c('bray', 'euclidean', 'manhattan', 'horn'),
                  method = 'spearman')

rank

# Bray-curtis performs well to separate communities along the fire severity gradient
# Although Euclidean and Kul also are good?!

```


```{r ANOSIM and adonis, eval=FALSE, include=FALSE}

# Attach severity data to species matrix

matrix_adj_sev <- matrix_adj
attach(sevs)



# Compare community similarity across fire severities using ANOSIM

smamm_ano <- anosim(matrix_adj_sev, severity)

summary(smamm_ano)
plot(smamm_ano)




# Compare community dispersion across fire severities using betadisper

smamm_dist <- vegdist(matrix_adj_sev)

smamm_bd <- betadisper(smamm_dist, severity)

smamm_bd
plot(smamm_bd)
boxplot(smamm_bd)

permutest(smamm_bd)
anova(smamm_bd)

# p > 0.5 for both --> no difference in dispersion across fire severities
# Satisfies the assumption for adonis



# Compare community similarity across fire severities using adonis
# Adonis is more robust because it is less sensitive to dispersion

smamm_ado <- adonis(matrix_adj_sev ~ severity,
                    permuatations = 999,
                    method = 'bray')

smamm_ado

# p = 0.001 --> communities are significantly different between fire severity treatments



# Pairwise Adonis

smamm_ado_ph <- pairwise.adonis(matrix_adj_sev, severity)

smamm_ado_ph

# Adjusted p-value (Bonferroni correction)
# unb vs mod: 0.216
# unb vs high: 0.003
# mod vs high: 0.051 (but this is sometime significant based on permutation)

```


```{r nmds, include=FALSE}

# NMDS with raw abundance data (2 dimensions)

ord <- metaMDS(matrix,
               distance = 'bray',
               k = 2)
ord$stress # stress = 0.18
stressplot(ord)



# NMDS with abundance data adjusted for trapping effort (2 dimensions)

set.seed(1)
ord_adj_2dim <- metaMDS(matrix_adj,
                        distance = 'bray',
                        k = 2)
ord_adj_2dim$stress # stress = 0.18
stressplot(ord_adj_2dim)



set.seed(2)
ord_adj_2dim_2 <- metaMDS(matrix_adj,
                          distance = 'bray',
                          k = 2)
ord_adj_2dim_2$stress # stress = 0.18
stressplot(ord_adj_2dim_2)


procrustes <- procrustes(ord_adj_2dim, ord_adj_2dim_2) # compares ordination solutions
summary(procrustes)
plot(procrustes)

# NMDS returns two solutions (local minima) which appear fairly different



# NMDS with abundance data adjusted for trapping effort (3 dimensions)

set.seed(5)
ord_adj_3dim <- metaMDS(matrix_adj,
                        distance = 'bray',
                        k = 3)

ord_adj_3dim$stress # stress = 0.09
stressplot(ord_adj_3dim)

# Only one solution with 3 dimensions and stress is sifnificantly lower, so this is probably the best model to use



# Scree plot to check stress per number of dimensions

dimcheckMDS(matrix_adj, distance = "bray", k = 10, trymax = 20)
# Stress is significantly reduced after 3 dimensions

```

###Community composition by severity

**Small mammal community varied across fire severities.**  The NMDS plot shows variation in community composition of small mammals, standardized by trapping effort. NMDS was performed on Bray-Curtis distances in three dimensions (stress = 0.09). Each circle represents a site, with the standard deviation of the centroids for each fire severity represented as color-coded ellipses (n = 9 for each). Community composition was significantly different between fire severity treatments (Adonis F(2,24) = 4.39, R^2^ = 0.268, p = 0.003). Post-hoc analysis by pairwise Adonis showed that community composition in unburned sites and high severity sites was significantly different (pairwise p = 0.006).

- Species codes:
    - SPBE = California ground squirrel
    - GLSA = northern flying squirrel
    - TAAM = yellow-pine chipmunk
    - TAQU = long-eared chipmunk
    - TASE = shadow chipmunk
    - NEFU = dusky-footed woodrat
    - PEMA = North American deer mouse
    - PEBO = brush mouse
    - PETR = Pinyon mouse
    - REME = western harvest mouse
    - SOTR = Trowbridge's shrew
- Considered using ANOSIM instead of Adonis, but Adonis is more robust because it is less sensitive to dispersion (also used betadisper to determine that dispersion was similar across treatments in order to satisfy assumptions of Adonis)
- Pairwise Adonis for moderate severity vs. high severity gave borderline p-value (p < 0.05 or p > 0.5 based on permutation)
- Ordination looked similar for both raw data and data adjusted for trapping effort
- Used three dimensions for NMDS in order to reduce stress (according to scree plot) and to avoid local minima (2 dimension nmds returned two solutions)

```{r nmds plot, echo=FALSE}

# 3 dimensions

colors <- c('darkgreen', 'orange', 'red')

par(mar = c(4,4,1,1))
plot(ord_adj_3dim, display = 'species',
     type = 'n')
text(ord_adj_3dim, display = 'sites',
       cex = 0.8, col = colors[sevs$severity])
ordiellipse(ord_adj_3dim, groups = sevs$severity,
            label = FALSE, col = colors, lwd = 2)
text(ord_adj_3dim, display = 'species',
     cex = 0.8)
title(main = 'NMDS in 3 dimensions')

# 2 dimensions

colors <- c('darkgreen', 'orange', 'red')

par(mar = c(4,4,1,1))
plot(ord_adj_2dim, display = 'species',
     type = 'n')
text(ord_adj_2dim, display = 'sites',
       cex = 0.8, col = colors[sevs$severity])
ordiellipse(ord_adj_2dim, groups = sevs$severity,
            label = FALSE, col = colors, lwd = 2)
text(ord_adj_2dim, display = 'species',
     cex = 0.8)
title(main = 'NMDS in 2 dimensions')

```


###Habitat drivers of community composition

```{r env, include=FALSE}

# Environmental variables

fit_2dim <- envfit(ord_adj_2dim, habitat[,3:16], permutations = 1000)

fit_2dim

fit_3dim <- envfit(ord_adj_3dim, habitat[,3:16], permutations = 1000)

fit_3dim

```

**Habitat drivers of small mammal communities.**  The NMDS plot shows variation in community composition of small mammals, standardized by trapping effort. NMDS was performed on on Bray-Curtis distances in three dimensions (stress = 0.09). Each circle represents a site, with the standard deviation of the centroids for each fire severity represented as color-coded ellipses (n = 9 for each). Arrows represent the relative contributions of several possible habitat variables. Community composition was significantly different between fire severity treatments (Adonis F(2,24) = 4.39, R^2^ = 0.268, p = 0.003). Post-hoc analysis by pairwise Adonis showed that community composition in unburned sites and high severity sites was significantly different (pairwise p = 0.006).

- Appears to be fewer sites because some of them exactly overlap
- Habitat variables:
    - tree_bm
    - shrub_bm
    - grass_bm
    - forb_bm
    - tree_density
    - tree_survival
    - veg_cover
    - litter_cover
    - cwd_volume
    - tree_H
    - shrub_H
    - forb_H
    
```{r env nmds, echo=FALSE}

# NMDS plot with arrows for environmental variables

# 3 dimensions

par(mar = c(4,4,1,1))
plot(ord_adj_3dim, display = 'sites',
     type = 'n')
points(ord_adj_3dim, display = 'sites',
       cex = 1.5, pch = 19, col = colors[sevs$severity])
ordiellipse(ord_adj_3dim, groups = sevs$severity, # by default plots ellipse with std error around centroids
            label = FALSE, col = colors, lwd = 2)
plot(fit_3dim,
     col = 'black', lwd = 3)

```


###Functional traits

```{r traits, eval=FALSE, include=FALSE}

# Functional trait variables

fit_3dim <- envfit(ord_adj_3dim, trait[,4:11], permutations = 1000)

fit_3dim

par(mar = c(4,4,1,1))
plot(ord_adj_3dim, display = 'sites',
     type = 'n')
points(ord_adj_3dim, display = 'sites',
       cex = 1.5, pch = 19, col = colors[sevs$severity])
ordiellipse(ord_adj_3dim, groups = sevs$severity, # by default plots ellipse with std error around centroids
            label = FALSE, col = colors, lwd = 2)
ordiArrowMul(trait[,4:11], display = 'vectors')
```

