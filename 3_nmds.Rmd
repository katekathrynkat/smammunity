---
title: "NMDS"
author: "Kate"
date: "December 23, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=5, fig.height=3, fig.align='center')
```


```{r packages and data, include=FALSE}

# Load necessary packages

library(tidyverse)
library(vegan)

# Load necessary data

smamms <- read_csv('./data/unique_smamms.csv') # using dataset with one row per unique individual
effort <- read_csv('./data/effort.csv')

```


```{r data wrangling, include=FALSE}

# Update classes

smamms <- smamms %>% 
  mutate(severity = factor(severity, levels = c('unb', 'mod', 'high')))

# Data frame containing only sites and severities

sevs <- smamms %>% 
  group_by(site) %>% 
  filter(row_number()==1) %>% 
  select(site, severity) %>% 
  arrange(severity)

```


```{r species matrices, include=FALSE}

# Create a species matrix

matrix_temp <- smamms %>% 
  mutate(site = factor(site, levels = sevs$site)) %>% # order sites by severity
  group_by(site, species) %>% 
  tally() %>% # count individuals per species per site
  spread(species, n) %>% # re-format into matrix
  ungroup() %>% 
  replace(., is.na(.), 0) # replace NAs with 0

sites <- matrix_temp$site # vector of just sites

matrix <- matrix_temp %>% 
  select(-site) # remove site column for input into vegan

matrix <- as.matrix(matrix)
rownames(matrix) <- sites



# Create a species matrix adjusted for trapping effort

matrix_temp <- smamms %>% 
  group_by(site, species) %>% 
  tally() %>% # count individuals per species per site
  full_join(., effort, by = 'site') %>% 
  mutate(n_adj = n/effort*300) %>% # add column for n adjusted for effort
  ungroup() %>% 
  mutate(site = factor(site, levels = sevs$site)) %>% # order sites by severity  
  select(site, species, n_adj) %>% 
  spread(species, n_adj) %>% # re-format into matrix
  replace(., is.na(.), 0) # replace NAs with 0

sites <- matrix_temp$site # vector of just sites

matrix_adj <- matrix_temp %>% 
  select(-site) # remove site column for input into vegan

matrix_adj <- as.matrix(matrix_adj)
rownames(matrix_adj) <- sites

```


```{r nmds, include=FALSE}

# NMDS with raw abundance data

smamm_ord <- metaMDS(matrix,
                     distance = 'bray',
                     k = 2, # number of dimensions
                     trymax = 100) # how many times we want it to try a random start



# NMDS with abundance data adjusted for trapping effort

smamm_ord_adj <- metaMDS(matrix_adj,
                         distance = 'bray',
                         k = 2,
                         trymax = 100)


```


```{r nmds plot, echo=FALSE}

# NMDS plot

colors <- c('darkgreen', 'orange', 'red')

par(mar = c(4,4,1,1))
plot(smamm_ord_adj,
     display = 'sites',
     type = 'n')
points(smamm_ord_adj,
       display = 'sites',
       cex = 1.5,
       pch = 19,
       col = colors[sevs$severity])
ordiellipse(smamm_ord_adj,
            groups = sevs$severity, # by default plots ellipse with std error around centroids
            label = FALSE,
            col = colors,
            lwd = 2)

```


```{r ANOSIM and adonis, eval=FALSE, include=FALSE}

# Compare community similarity across fire severities using ANOSIM

smamm_matrix <- matrix_adj
attach(sevs)

smamm_ano <- anosim(smamm_matrix, severity)

summary(smamm_ano)
plot(smamm_ano)




# Compare community dispersion across fire severities using betadisper

smamm_dist <- vegdist(smamm_matrix)

smamm_bd <- betadisper(smamm_dist, severity)

smamm_bd
plot(smamm_bd)
boxplot(smamm_bd)

permutest(smamm_bd)
anova(smamm_bd)

# p > 0.5 for both --> no difference in dispersion across fire severities
# Satisfies the assumption for adonis



# Compare community similarity across fire severities using adonis
# Adonis is more robust because it is less sensitive to dispersion

smamm_ado <- adonis(smamm_matrix ~ severity)

smamm_ado

```

**Small mammal community varied across fire severities.**  The NMDS plot shows variation in community composition of small mammals, standardized by trapping effort. Each circle represents a site, with the standard deviation of the centroids for each fire severity represented as color-coded ellipses (n = 9 for each). Community composition was significantly different between fire severity treatments (Adonis F(2,24) = 4.39, R^2^ = 0.268, p = 0.003).

- Paired figure with column graph of proportional abundance across severities per species