---
title: "secr"
author: "Kate"
date: "November 9, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r packages and data, include=FALSE}

# Install necessary packages
library(tidyverse)
library(secr)
library(dunn.test)

# Load necessary data
smamms <- read_csv('smamms.csv')
trap <- read_csv("trapmatrix.csv")
meta <- read_csv('sites.csv')

```


```{r create files}

# Create trap file
trap1 <- trap %>% 
  rename(detector = trapID)
trapf<-read.traps(data = trap1, detector = "multi", trapID = 'detector')

write_csv(trap1,'smamms_trap.csv', col_names = FALSE) # read.capthist does NOT work with column names (headers

# Create capture file
capt<-smamms %>%
  filter(!is.na(indID))%>% # captures only
  mutate(session = as.factor(paste0(site, '-', species)), # session: unique for each species at each site
         occassion = ifelse(is.na(catnum), day, paste0('-', day))) %>% # adding a - for animals that died on capture
  filter(species=='PEMA') %>% # PEMA only
  filter(site=='HICORN') %>% # just one site, for a test
  select(session, indID, occassion, trap) %>% 
  rename(session = session,
         ID = indID,
         detector = trap)

capt$detector <- as.factor(capt$detector)

capt <- as.data.frame(capt)

write_csv(capt,'smamms_capt.csv', col_names = FALSE) # read.capthist does NOT work with column names (headers)

# Create capture history object

smammCH <- read.capthist('smamms_capt.csv', 'smamms_trap.csv',
                         detector = 'multi',
                         fmt = 'trapID',
                         noccasions = 3)

```



```{r summary}

# Summary
summary(smammCH)

# Plot
par(mar = c(1,1,3,1)) # reduce margins
plot(smammCH, tracks=TRUE)

# Histogram of movement distance
m <- unlist(moves(smammCH))
par(mar = c(3.2,4,1,1), mgp = c(2.1,0.6,0)) # reduce margins
hist(m, xlab = "Movement m", main = "")

```


```{r basic model}

# Test a basic model
initialsigma <- RPSV(smammCH, CC = TRUE) # quick and biased estimate of sigma

fit <- secr.fit(smammCH,
                buffer = 4 * initialsigma, # unlikely that PEMA will go outside this parameter
                trace = FALSE)

fit # D in the last table is the estimated density

```


```{r comparing models}

# Compare three models

# Half-normal
fit_HN <- secr.fit (smammCH, buffer = 6 * initialsigma, detectfn = 'HN', trace = FALSE)

# Negative exponential
fit_EX <- secr.fit (smammCH, buffer = 6 * initialsigma, detectfn = 'EX', trace = FALSE)

# Hazard rate
fit_HR <- secr.fit (smammCH, buffer = 6 * initialsigma, detectfn = 'HR', trace = FALSE)

# Bundle and compare models
fits <- secrlist(HN = fit_HN, EX = fit_EX, HR = fit_HR)

predict(fits) # similar estimates of D except for HR (underestimating)

AIC(fits) # formal model comparison: 1) HR, 2) EX, 3) HN

par(mar = c(4,4,2,2))
esa.plot(fits, max.buffer = 6 * initialsigma) # HR doesn't plateau as much as EX and HN --> estimates are more affected by buffer width

# Use EX model (negative exponential)
fit_EX

param <- derived(fit_EX)
param$estimate[2] # estimated density

```

```{r RUN FOR EACH SITE}

# Condensed code: run for each site separately to get density estimate

# Create capture file
capt<-smamms %>%
  mutate(session = as.factor(paste0(site, '-', species)), 
         occassion = ifelse(is.na(catnum), day, paste0('-', day))) %>% 
  filter(species=='PEMA') %>% 
  filter(site=='MIXWAT') %>% # CHANGE SITE HERE
  select(session, indID, occassion, trap) %>% 
  rename(session = session,
         ID = indID,
         detector = trap)
capt$detector <- as.factor(capt$detector)
capt <- as.data.frame(capt)
write_csv(capt,'smamms_capt.csv', col_names = FALSE) 
# Create capture history object
smammCH <- read.capthist('smamms_capt.csv', 'smamms_trap.csv',
                         detector = 'multi',
                         fmt = 'trapID',
                         noccasions = 3)
initialsigma <- RPSV(smammCH, CC = TRUE)
# Negative exponential model
fit_EX <- secr.fit (smammC,
                    buffer = 6 * initialsigma, detectfn = 'EX', trace = FALSE)
param <- derived(fit_EX)
param$estimate[2]



```


```{r data frame of densities}

densities <- c(0.6453089, 4.800268, 4.051649,
               5.908946, 3.812545, 8.822407,
               8.649417, 8.121382, 5.749518,
               13.71822, 1.363503, 1.120058,
               4.429102, 3.835955, 16.45039,
               2.958632, 3.321139, 0.5888588,
               21.37639, 12.19324, 44.1339,
               6.394768, 18.75583, 12.69593,
               9.028069, 16.74234, 10.95847)

sites <- c('GRNCAR', 'GRNDAM', 'GRNHOU',
           'GRNKAN', 'GRNMAS', 'GRNQUA',
           'GRNSNO', 'GRNTUR', 'GRNWOO',
           'MIXBUS', 'MIXBUT', 'MIXDP2',
           'MIXMID', 'MIXMIX', 'MIXMOR',
           'MIXRAV', 'MIXRIV', 'MIXWAT',
           'HIBADR', 'HICAMP', 'HICORN',
           'HICOWS', 'HIDODD', 'HISHRU',
           'HISQUE', 'HITEDD', 'HIWALK')

sevs <- c(rep('low',9), rep('med', 9), rep('high', 9))

density <- data_frame(sites, sevs, densities) %>% 
  rename(
    site = sites,
    severity = sevs,
    D = densities
  )
density$severity <- factor(density$severity, levels = c('low', 'med', 'high'))

```


```{r data distribution}

# Explore the data distribution

# Make histograms for each treatment
D_hist <- ggplot(density, aes(x = D)) +
  geom_histogram() +
  facet_wrap(~severity)

D_hist

# Make qqplots for each treatment
D_qq <- ggplot(density, aes(sample = D)) +
  geom_qq() +
  facet_wrap(~severity)

D_qq

# Histograms look a little funky because sample size is so small
# qq-plots are weird???
# n=9 for each severity, so cannot use CLT to justify normality

```


```{r data variance}

# Explore variance
variances <- density %>% 
  group_by(severity) %>% 
  summarize(
    variance = var(D)
  )

variances

# The variances are WAY different
# Cannot satisfy assumptions of ANOVA

```


```{r kruskal-wallis and post-hoc tests}

# Test for significant differences in means

# Kruskal Wallis

D_kw <- kruskal.test(D ~ severity, data = density)

D_kw
# p<0.05, so there is at least 1 sig dif in means

# Post-hoc pairwise testing

# Dunn's test
dunn.test(density$D, density$severity,
          method = 'bonferroni') # Bonferroni correction

# High severity is sig different from both unburned and mixed severity
# Unburned and mixed severity are not different from each other

```


```{r boxplot}

# Summarize data with boxplots
colors <- c('darkgreen', 'orange', 'red')
xlabs <- c('Unburned', 'Mixed Severity', 'High Severity') 

H_boxplot <- ggplot(density, aes(x = severity, y = D)) +
  geom_boxplot(aes(fill = severity)) +
  scale_fill_manual(values = colors) +
  theme_minimal() +
  labs(x = 'Fire Severity',
       y = substitute(paste(
         italic('P. maniculatus'), " density (indv/ha)"
         ))) +
  theme(legend.position = 'NA') +
  scale_x_discrete(labels = xlabs)

H_boxplot

# Calculate mean diversity for each treatment

D_summary <- density %>% 
  group_by(severity) %>% 
  summarise(
    D_mean = mean(D),
    D_sd = sd(D)
  )

```
